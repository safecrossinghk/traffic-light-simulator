<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“å³æ™‚äººæµæŸ¥è©¢</title>
<link
rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
body {
font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
font-size: 18px;
padding: 1rem;
}
input, button {
font-size: 1rem;
padding: 0.4rem;
margin: 0.2rem;
}
#map {
height: 300px;
margin-top: 1rem;
}
.mobile-friendly {
font-size: 1.1rem;
}
</style>
</head>
<body>
<h3>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</h3>
<label for="place">æŸ¥è©¢åœ°é»é—œéµå­—ï¼š</label>
<input id="place" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯åœ‹éš›æ©Ÿå ´" />
<button onclick="search()">æŸ¥è©¢</button>
<div id="result" class="mobile-friendly"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let marker;

function initMap(lat = 22.3193, lon = 114.1694) {
if (!map) {
map = L.map("map").setView([lat, lon], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
attribution: "&copy; OpenStreetMap contributors",
}).addTo(map);
} else {
map.setView([lat, lon], 12);
if (marker) map.removeLayer(marker);
}

marker = L.marker([lat, lon]).addTo(map);
}

async function search() {
const place = document.getElementById("place").value.trim();
const resultDiv = document.getElementById("result");
resultDiv.innerHTML = "";

if (!place) {
resultDiv.innerHTML = "âš ï¸ è«‹è¼¸å…¥æŸ¥è©¢åœ°é»ã€‚";
return;
}

const res = await fetch(
`https://safecrossinghk-cf.outscraper.workers.dev/search?q=${encodeURIComponent(place)}`
);
const data = await res.json();
console.log("API å›å‚³:", data);

if (
!data.success ||
!Array.isArray(data.popular_times) ||
data.popular_times.length === 0
) {
resultDiv.innerHTML = `âš ï¸ æŸ¥ç„¡å³æ™‚äººæµè³‡æ–™ï¼š${place}`;
return;
}

const weekIndex = new Date().getDay(); // 0 = Sunday
const hour = new Date().getHours();
const hourData = data.popular_times[weekIndex]?.data?.[hour];

if (hourData === undefined) {
resultDiv.innerHTML = `âš ï¸ ${place} æ²’æœ‰è©²æ™‚æ®µäººæµè³‡æ–™`;
return;
}

const percent = hourData;
resultDiv.innerHTML = `ğŸ“ æŸ¥è©¢åœ°é»ï¼š${data.query_used}<br>ğŸ‘¥ ç¾æ™‚äººæµï¼šäººæ°£æ­£ç‡ï¼ˆç´„ ${percent}%ï¼‰`;

if (data.location) {
initMap(data.location.lat, data.location.lng);
} else {
resultDiv.innerHTML += `<br>âš ï¸ æ²’æœ‰ç¶“ç·¯åº¦è³‡æ–™ï¼Œåœ°åœ–ç„¡æ³•é¡¯ç¤º`;
}

// èªéŸ³æç¤ºï¼ˆä¸­è‹±ï¼‰
const msg = new SpeechSynthesisUtterance(`ç¾æ™‚ ${place} äººæµå¤§ç´„ ${percent}%ã€‚`);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);
}

// é è¨­è¼‰å…¥é¡¯ç¤ºé¦™æ¸¯åœ°åœ–
window.onload = () => {
initMap();
};
</script>
</body>
</html>