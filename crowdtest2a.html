<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>ç´…åå­—æœƒé›¨é‡ + ä½ çš„ä½ç½®æç¤º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
margin: 0;
padding: 0;
font-family: sans-serif;
background: #f0f0f0;
}
#alert {
background: yellow;
padding: 10px;
font-weight: bold;
text-align: center;
display: none;
}
iframe {
width: 100%;
height: 70vh;
border: none;
}
#location-map {
height: 30vh;
width: 100%;
}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
</head>
<body>

<div id="alert">ğŸ”„ æ­£åœ¨æª¢æŸ¥ä½ çš„ä½ç½®èˆ‡é›¨é‡é å ±...</div>

<!-- ç´…åå­—æœƒ iframe åœ–å±¤ -->
<iframe src="https://www.redcross.org.hk/weather/rainfall_nowcast.html"></iframe>

<!-- åœ°åœ–é¡¯ç¤ºä½¿ç”¨è€…ä½ç½® -->
<div id="location-map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
// ç²µèªèªéŸ³æç¤º
function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);
}

// æª¢æŸ¥é›¨é‡é å ±
async function checkRain(lat, lon) {
const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rainfallForecast&lang=tc");
const data = await res.json();

const forecast = data.rainfallForecast.data;
let found = false;

for (const area of forecast) {
const dist = Math.sqrt(
Math.pow(lat - area.latitude, 2) + Math.pow(lon - area.longitude, 2)
);

if (dist < 0.1 && area.max_rainfall > 5) { // è·é›¢å°æ–¼ç´„10å…¬é‡Œ
const msg = `âš ï¸ ä½ é™„è¿‘æœªä¾† ${area.valid_time} åˆ†é˜å¯èƒ½æœ‰å¤§é›¨ï¼š${area.max_rainfall} æ¯«ç±³`;
document.getElementById("alert").innerText = msg;
document.getElementById("alert").style.display = "block";
speak("ä½ é™„è¿‘æœªä¾†å¯èƒ½æœ‰å¤§é›¨ï¼Œè«‹ç•™æ„å¤©æ°£è®ŠåŒ–");
found = true;
break;
}
}

if (!found) {
document.getElementById("alert").innerText = "âœ… ä½ é™„è¿‘æš«æ™‚æ²’æœ‰å¤§é›¨é å ±";
document.getElementById("alert").style.display = "block";
}
}

// åˆå§‹åŒ– Leaflet åœ°åœ–ä¸¦æ¨™ç¤ºä½ç½®
function showMap(lat, lon) {
const map = L.map('location-map').setView([lat, lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);
L.marker([lat, lon]).addTo(map).bindPopup("ä½ çš„ä½ç½®").openPopup();
}

// å•Ÿå‹•å®šä½
navigator.geolocation.getCurrentPosition(pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
showMap(lat, lon);
checkRain(lat, lon);
}, err => {
document.getElementById("alert").innerText = "âŒ ç„¡æ³•å–å¾—ä½ çš„ä½ç½®";
document.getElementById("alert").style.display = "block";
});
</script>
</body>
</html>
