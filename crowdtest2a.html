<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>紅十字會雨量 + 你的位置提示</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
margin: 0;
padding: 0;
font-family: sans-serif;
background: #f0f0f0;
}
#alert {
background: yellow;
padding: 10px;
font-weight: bold;
text-align: center;
display: none;
}
iframe {
width: 100%;
height: 70vh;
border: none;
}
#location-map {
height: 30vh;
width: 100%;
}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
</head>
<body>

<div id="alert">🔄 正在檢查你的位置與雨量預報...</div>

<!-- 紅十字會 iframe 圖層 -->
<iframe src="https://www.redcross.org.hk/weather/rainfall_nowcast.html"></iframe>

<!-- 地圖顯示使用者位置 -->
<div id="location-map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
// 粵語語音提示
function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);
}

// 檢查雨量預報
async function checkRain(lat, lon) {
const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rainfallForecast&lang=tc");
const data = await res.json();

const forecast = data.rainfallForecast.data;
let found = false;

for (const area of forecast) {
const dist = Math.sqrt(
Math.pow(lat - area.latitude, 2) + Math.pow(lon - area.longitude, 2)
);

if (dist < 0.1 && area.max_rainfall > 5) { // 距離小於約10公里
const msg = `⚠️ 你附近未來 ${area.valid_time} 分鐘可能有大雨：${area.max_rainfall} 毫米`;
document.getElementById("alert").innerText = msg;
document.getElementById("alert").style.display = "block";
speak("你附近未來可能有大雨，請留意天氣變化");
found = true;
break;
}
}

if (!found) {
document.getElementById("alert").innerText = "✅ 你附近暫時沒有大雨預報";
document.getElementById("alert").style.display = "block";
}
}

// 初始化 Leaflet 地圖並標示位置
function showMap(lat, lon) {
const map = L.map('location-map').setView([lat, lon], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '© OpenStreetMap contributors'
}).addTo(map);
L.marker([lat, lon]).addTo(map).bindPopup("你的位置").openPopup();
}

// 啟動定位
navigator.geolocation.getCurrentPosition(pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
showMap(lat, lon);
checkRain(lat, lon);
}, err => {
document.getElementById("alert").innerText = "❌ 無法取得你的位置";
document.getElementById("alert").style.display = "block";
});
</script>
</body>
</html>
