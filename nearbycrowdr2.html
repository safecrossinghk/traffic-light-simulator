<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>é™„è¿‘äººæµæƒ…æ³</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#info { margin-top: 20px; }
.location { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; }
.fallback { color: gray; font-style: italic; }
button { margin-right: 10px; }
</style>
</head>
<body>
<h1>ğŸ“ é™„è¿‘äººæµæƒ…æ³</h1>
<div>
<button onclick="setLang('zh')">ä¸­æ–‡</button>
<button onclick="setLang('en')">English</button>
<button onclick="fetchNearby()">ğŸ” æ‰‹å‹•æ›´æ–°</button>
</div>
<div id="info">è¼‰å…¥ä¸­...</div>

<audio id="voice" src=""></audio>

<script>
const apiKey = 'MWE3NWNmMzFjZWNiNGMxMDlhNGNhNDFjNTY3ZjZkMTB8NzY5ZGY0MGQ0Zg'; // æ›¿æ›ç‚ºä½ çš„é‡‘é‘°
let currentLang = 'zh';

function setLang(lang) {
currentLang = lang;
fetchNearby();
}

async function fetchNearby() {
document.getElementById('info').innerHTML = 'ğŸ”„ æ­£åœ¨æ›´æ–°...';

try {
const pos = await getCurrentPosition();
const lat = pos.coords.latitude;
const lng = pos.coords.longitude;

const endpoint = `https://api.outscraper.com/maps/search-v2?query=transit+station&lat=${lat}&lng=${lng}&limit=5&language=en`;
const res = await fetch(endpoint, {
headers: {
'X-API-KEY': apiKey,
'Content-Type': 'application/json'
}
});

if (!res.ok) throw new Error('API éŒ¯èª¤ï¼š' + res.status);

const data = await res.json();
if (!data.data || !Array.isArray(data.data) || data.data.length === 0) throw new Error('ç„¡åœ°é»è³‡æ–™');

const places = data.data;
const container = document.getElementById('info');
container.innerHTML = '';

for (const place of places) {
const div = document.createElement('div');
div.className = 'location';
const name = place.title;
const popularity = place.popular_times?.[new Date().getDay()]?.[new Date().getHours()];
let status = '';
let voiceFile = '';

if (typeof place.current_popularity === 'number') {
const level = place.current_popularity;
if (level >= 70) {
status = currentLang === 'zh' ? 'äººæµæ“ è¿«' : 'Crowded';
voiceFile = currentLang === 'zh' ? 'crowded.mp3' : 'crowded_en.mp3';
} else if (level >= 30) {
status = currentLang === 'zh' ? 'äººæµæ­£å¸¸' : 'Normal crowd';
voiceFile = currentLang === 'zh' ? 'normal.mp3' : 'normal_en.mp3';
} else {
status = currentLang === 'zh' ? 'äººæµç¨€ç–' : 'Quiet';
voiceFile = currentLang === 'zh' ? 'quiet.mp3' : 'quiet_en.mp3';
}
} else {
status = currentLang === 'zh' ? 'åƒ…æä¾›æ­·å²äººæµè³‡æ–™' : 'Only historical data available';
div.classList.add('fallback');
}

div.innerHTML = `<strong>${name}</strong><br/>${status}`;
container.appendChild(div);

if (voiceFile) {
playVoice(voiceFile);
}
}
} catch (e) {
console.error(e);
document.getElementById('info').innerHTML = 'âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦';
}
}

function playVoice(file) {
const audio = document.getElementById('voice');
audio.src = file;
audio.play().catch(e => console.warn('èªéŸ³æ’­æ”¾å¤±æ•—', e));
}

function getCurrentPosition() {
return new Promise((resolve, reject) => {
navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
});
}

// æ¯ 5 åˆ†é˜è‡ªå‹•æ›´æ–°
setInterval(fetchNearby, 300000);
window.onload = fetchNearby;
</script>
</body>
</html>
