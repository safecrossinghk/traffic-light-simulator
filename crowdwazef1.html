<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è”æè§’äººæµï¼‹å³æ™‚å¤©æ°£ï¼†é›¨é‡é å ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{ font-family:sans-serif; padding:1em; background:#eef2f5; }
#topbar{ position:fixed; top:0; left:0; right:0; padding:0.5em; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.1); z-index:100; }
#content{ margin-top:4em; }
.btn, select{ width:100%; padding:0.8em; font-size:1.1em; margin:0.5em 0; }
#crowdInfo,#rainInfo{ background:#fff; padding:1em; margin-top:0.5em; border-radius:6px; }
iframe{ width:100%; height:280px; border:0; border-radius:6px; margin-top:1em; }
</style>
</head>
<body>
<div id="topbar">
<span id="winfo">è¼‰å…¥å¤©æ°£ä¸­â€¦</span>
</div>
<div id="content">
<h2>ğŸ“ è”æè§’äººæµï¼‹å³æ™‚å¤©æ°£èˆ‡é›¨é‡é å ±</h2>
<select id="loc">
<option disabled selected>é¸æ“‡æŸ¥è©¢åœ°é»</option>
<option>è”æè§’ç«™å‡ºå£ A</option>
<option>D2 Place</option>
<option>é•·æ²™ç£å»£å ´</option>
<option>D2 Place Two</option>
<option>æ³“æ™¯åŒ¯</option>
</select>
<div id="crowdInfo"></div>
<div id="rainInfo"></div>
<iframe id="waze"></iframe>
</div>

<script>
const workerBase = "https://crowdwazefr.ctakwah.workers.dev/"; // æ›¿æ›

const coords = {
"è”æè§’ç«™å‡ºå£ A":[22.3378,114.1472],
"D2 Place":[22.3376,114.1483],
"é•·æ²™ç£å»£å ´":[22.3379,114.1518],
"D2 Place Two":[22.3389,114.1493],
"æ³“æ™¯æ»™":[22.3380,114.1500]
};

async function loadWeather() {
try {
const r = await fetch(`${workerBase}?mode=weather`);
const j = await r.json();
const t = j.rhr.temperature;
const wx = j.rhr.weather;
const st = j.rainfall.data.find(d=>d.stationEng==="Kwai Chung");
const rainNow = st?.rainfall ?? 0;
const warn = j.warn.warningSummary || "ç„¡è­¦å‘Š";
const text = `å¤©æ°£ï¼š${wx}ï¼Œæº«åº¦ï¼šç´„ ${t}Â°Cï¼Œé›¨é‡ï¼šç´„ ${rainNow}â€¯mmï¼å°æ™‚ï¼Œè­¦å‘Šï¼š${warn}`;
document.getElementById("winfo").textContent = text;
speechSynthesis.speak(new SpeechSynthesisUtterance(text));
simulateRainForecast();
} catch(e){
document.getElementById("winfo").textContent = "å¤©æ°£è³‡æ–™è¼‰å…¥å¤±æ•—";
}
}

function simulateRainForecast(){
const forecast = [
{mins:10, mm:1.2},
{mins:20, mm:3.0},
{mins:30, mm:6.5}
];
const f20 = forecast.find(f=>f.mins===20);
let info = `â˜”ï¸ ${f20.mins}åˆ†é˜å¾Œå¯èƒ½æœ‰ä¸­é›¨ï¼ˆç´„ ${f20.mm.toFixed(1)}mmï¼‰ï¼Œå»ºè­°å¸¶å‚™é›¨å…·ï¼`;
if (forecast.some(f=>f.mm>5)){
info += "<br>âš ï¸ æ³¨æ„ï¼šè”æè§’å€å³å°‡å‡ºç¾å¤§é›¨ï¼";
speechSynthesis.speak(new SpeechSynthesisUtterance("æ³¨æ„ï¼šè”æè§’å€å³å°‡æœ‰å¤§é›¨"));
}
document.getElementById("rainInfo").innerHTML = info;
}

async function loadCrowd(loc) {
const r = await fetch(`${workerBase}?mode=crowd&location=${encodeURIComponent(loc)}`);
const j = await r.json();
let html = `ğŸ“Œ åœ°é»ï¼š${loc}<br>`;
if (j.status==="Success" && j.data?.popular_times){
const live = j.data.popular_times.find(x=>x.day==="live");
const pct = live?.percentage ?? null;
if (pct!==null){
const label = pct>=80?"ğŸ”´ éå¸¸ç¹å¿™":pct>=20?"ğŸŸ¡ æ­£å¸¸":"ğŸŸ¢ åå°‘";
html += `ğŸ‘¥ ç¾æ™‚äººæµï¼š${label}ï¼ˆç´„ ${pct}%ï¼‰`;
speechSynthesis.speak(new SpeechSynthesisUtterance(`${loc} ç¾æ™‚äººæµ ${label}ï¼Œç´„ ${pct} ç™¾åˆ†æ¯”`));
} else html += "âš ï¸ ç„¡å›å‚³äººæµç™¾åˆ†æ¯”";
} else html += `âš ï¸ ç„¡æ³•å–å¾—äººæµè³‡æ–™ (${j.error||j.status})`;
document.getElementById("crowdInfo").innerHTML = html;
}

document.getElementById("loc").addEventListener("change", e=>{
const loc = e.target.value;
loadCrowd(loc);
const [lat,lon] = coords[loc]||[22.3378,114.148];
document.getElementById("waze").src = `https://embed.waze.com/iframe?zoom=15&lat=${lat}&lon=${lon}&pin=1&q=${encodeURIComponent(loc)}`;
});

loadWeather();
</script>
</body>
</html>