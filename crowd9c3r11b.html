<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body {
font-family: sans-serif;
padding: 20px;
font-size: 18px;
}
input, button {
padding: 10px;
font-size: 18px;
margin: 5px 0;
}
#result {
margin-top: 20px;
}
#map {
height: 300px;
margin-top: 20px;
}
.busy {
color: red;
font-weight: bold;
}
.normal {
color: green;
font-weight: bold;
}
</style>
</head>
<body>

<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</h2>

<label>æŸ¥è©¢åœ°é»é—œéµå­—ï¼š</label>
<input id="keyword" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯åœ‹éš›æ©Ÿå ´" />
<button onclick="query()">æŸ¥è©¢</button>

<div id="result"></div>
<div id="map"></div>

<script>
let map; // åœ°åœ–ç‰©ä»¶å…¨åŸŸå®£å‘Š
let marker; // æ¨™è¨˜é»

// é è¨­è¼‰å…¥é¦™æ¸¯åœ°åœ–
window.onload = () => {
map = L.map("map").setView([22.302711, 114.177216], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19,
}).addTo(map);
};

async function query() {
const q = document.getElementById("keyword").value.trim();
const resultDiv = document.getElementById("result");
resultDiv.innerHTML = "";

if (!q) {
resultDiv.innerHTML = "â— è«‹è¼¸å…¥æŸ¥è©¢åœ°é»ã€‚";
return;
}

try {
const res = await fetch("https://tiny-disk-0d7b.ctakwah.workers.dev/?query=" + encodeURIComponent(q));
const data = await res.json();

console.log("âœ… API å›å‚³ï¼š", data);

if (!data.success || !data.popular_times) {
resultDiv.innerHTML = "âš ï¸ æŸ¥ç„¡å³æ™‚äººæµè³‡æ–™ã€‚";
return;
}

const now = new Date();
const hour = now.getHours();
const todayIndex = now.getDay(); // Sunday = 0
const weekIndex = todayIndex === 0 ? 6 : todayIndex - 1;
const hourData = data.popular_times[weekIndex]?.data?.[hour];

const label = hourData >= 70 ? "éå¸¸ç¹å¿™" : "äººæµæ­£å¸¸";
const className = hourData >= 70 ? "busy" : "normal";

resultDiv.innerHTML = `
ğŸ“Œ æŸ¥è©¢åœ°é»ï¼š${q}<br>
ğŸ‘¥ ç¾æ™‚äººæµï¼š<span class="${className}">${label}ï¼ˆç´„ ${hourData}%ï¼‰</span><br>
`;

// èªéŸ³æ’­å ±
const msg = new SpeechSynthesisUtterance();
msg.lang = "zh-HK";
msg.text = `${q}ç¾æ™‚äººæµï¼š${label}`;
speechSynthesis.speak(msg);

// é¡¯ç¤ºåœ°åœ–
let lat = data.location?.lat;
let lng = data.location?.lng;

// fallback å¾ popular_times å–åæ¨™
if ((lat === undefined || lng === undefined) && data.popular_times.length > 0) {
lat = data.popular_times[0].coordinates?.lat;
lng = data.popular_times[0].coordinates?.lng;
}

if (!lat || !lng) {
resultDiv.innerHTML += `<br>âš ï¸ æ²’æœ‰ç¶“ç·¯åº¦è³‡æ–™ï¼Œåœ°åœ–ç„¡æ³•é¡¯ç¤º`;
return;
}

console.log("ğŸ“Œ ç¶“ç·¯åº¦ï¼š", lat, lng);

// æ›´æ–°åœ°åœ–è¦–è§’èˆ‡æ¨™è¨˜
map.setView([lat, lng], 17);

if (marker) {
marker.setLatLng([lat, lng]).setPopupContent(q).openPopup();
} else {
marker = L.marker([lat, lng]).addTo(map).bindPopup(q).openPopup();
}

} catch (e) {
console.error("âŒ éŒ¯èª¤ï¼š", e);
resultDiv.innerHTML = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + e.message;
}
}
</script>

</body>
</html>