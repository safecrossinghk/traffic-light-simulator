<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è”æè§’äººæµ + Waze åœ°åœ–</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #result span.busy { color: red; font-weight: bold; }
    #result span.normal { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2>è”æè§’äººæµ + Waze åœ°åœ–</h2>
  <select onchange="onLocationChange(this.value)">
    <option value="">è«‹é¸æ“‡åœ°é»</option>
    <option value="è”æè§’ç«™å‡ºå£ A">è”æè§’ç«™å‡ºå£ A</option>
    <option value="D2 Place">D2 Place</option>
    <option value="D2 Place Two">D2 Place Two</option>
    <option value="é•·æ²™ç£å»£å ´">é•·æ²™ç£å»£å ´</option>
    <option value="æ³“æ™¯åŒ¯">æ³“æ™¯åŒ¯</option>
  </select>
  <p id="result">ğŸ‘ˆ è«‹é¸æ“‡åœ°é»</p>
  <iframe id="wazeMap" width="100%" height="400" src="" allowfullscreen></iframe>
  <hr />
  <p id="weather">ğŸŒ¦ è¼‰å…¥å¤©æ°£è³‡æ–™ä¸­...</p>

<script>
const wazeUrls = {
  "è”æè§’ç«™å‡ºå£ A": "https://embed.waze.com/iframe?zoom=17&lat=22.338611&lon=114.149444&pin=1",
  "D2 Place": "https://embed.waze.com/iframe?zoom=17&lat=22.338336&lon=114.149792&pin=1",
  "é•·æ²™ç£å»£å ´": "https://embed.waze.com/iframe?zoom=17&lat=22.337858&lon=114.152069&pin=1",
  "D2 Place Two": "https://embed.waze.com/iframe?zoom=17&lat=22.338877&lon=114.149200&pin=1",
  "æ³“æ™¯åŒ¯": "https://embed.waze.com/iframe?zoom=17&lat=22.336136&lon=114.155181&pin=1"
};

async function fetchWithRetry(query, retries = 3, delay = 800) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch("https://tiny-disk-0d7b.ctakwah.workers.dev/?query=" + encodeURIComponent(query));
      if (!res.ok) throw new Error("HTTP error " + res.status);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "æœªçŸ¥éŒ¯èª¤");
      return data;
    } catch (err) {
      if (i === retries - 1) throw err;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}

async function queryLocation(name) {
  document.getElementById("result").textContent = "â³ æ­£åœ¨æŸ¥è©¢ä¸­...";
  document.getElementById("wazeMap").src = wazeUrls[name];

  try {
    const data = await fetchWithRetry(name);
    let percentage = null;
    if (Array.isArray(data.popular_times)) {
      const live = data.popular_times.find(d => d.day === "live");
      if (live && typeof live.percentage === "number") {
        percentage = live.percentage;
      }
    }

    if (percentage === null) {
      document.getElementById("result").textContent = "âš ï¸ ç„¡æ³•å–å¾—å³æ™‚äººæµè³‡æ–™ã€‚";
      return;
    }

    let label = "ğŸŸ¢ åå°‘";
    if (percentage >= 80) label = "ğŸ”´ éå¸¸ç¹å¿™";
    else if (percentage >= 20) label = "ğŸŸ¡ æ­£å¸¸";

    document.getElementById("result").innerHTML =
      `ğŸ“Œ åœ°é»ï¼š${name}<br>ğŸ‘¥ ç¾æ™‚äººæµï¼š<span class="${percentage >= 70 ? 'busy' : 'normal'}">${label}ï¼ˆç´„ ${percentage}%ï¼‰</span>`;

    const msg = new SpeechSynthesisUtterance(`${name} ç¾æ™‚äººæµï¼š${label}`);
    msg.lang = "zh-HK";
    speechSynthesis.speak(msg);

  } catch (e) {
    console.error(e);
    document.getElementById("result").textContent = "âŒ æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
  }
}

function onLocationChange(value) {
  if (value) queryLocation(value);
}

async function loadWeather() {
  try {
    const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc");
    const data = await res.json();

    const temp = data.temperature.data.find(d => d.place === "é¦™æ¸¯å¤©æ–‡å°");
    const humidity = data.humidity.data[0];

    const iconCode = data.icon[0];
    const iconUrl = `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${iconCode}.png`;

    let warning = "â˜ ç„¡ç‰¹åˆ¥å¤©æ°£è­¦å‘Š";
    if (Array.isArray(data.warningMessage)) {
      warning = data.warningMessage.join("ï¼Œ");
    } else if (typeof data.warningMessage === "string" && data.warningMessage.trim() !== "") {
      warning = data.warningMessage;
    }

    document.getElementById("weather").innerHTML = `
      <img src="${iconUrl}" alt="å¤©æ°£åœ–ç¤º" style="height:24px;vertical-align:middle;"> 
      å¤©æ°£ï¼š ï½œ æº«åº¦ ${temp?.value || 'æœªçŸ¥'}Â°C ï½œ æ¿•åº¦ ${humidity?.value || 'æœªçŸ¥'}% <br>
      ğŸ”” ${warning}`;

    // å‘¼å«é›¨é‡é æ¸¬
    loadRainForecast();

  } catch (e) {
    console.error(e);
    document.getElementById("weather").textContent = "âš ï¸ ç„¡æ³•è¼‰å…¥å¤©æ°£è³‡æ–™ã€‚";
  }
}

async function loadRainForecast() {
  try {
    const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rainfall&lang=tc&rformat=json");
    const data = await res.json();

    const item = data.record.rainfall.data.find(d => d.place === "è”æè§’");
    const mm = parseFloat(item?.max || "0");

    let forecastMsg = `â˜”ï¸ è”æè§’é›¨é‡ï¼š${mm} æ¯«ç±³`;
    if (mm > 5) {
      forecastMsg += "ï¼ˆâš ï¸ å¯èƒ½æœ‰ä¸­è‡³å¤§é›¨ï¼‰";

      const msg = new SpeechSynthesisUtterance(`æ³¨æ„ï¼Œè”æè§’åœ°å€æœªä¾†å¯èƒ½æœ‰ä¸­é›¨ï¼Œé›¨é‡ç‚º ${mm} æ¯«ç±³ã€‚`);
      msg.lang = "zh-HK";
      speechSynthesis.speak(msg);
    }

    document.getElementById("weather").innerHTML += `<br>${forecastMsg}`;

  } catch (e) {
    console.error(e);
    document.getElementById("weather").innerHTML += "<br>âš ï¸ é›¨é‡é æ¸¬å¤±æ•—";
  }
}

loadWeather();
</script>
</body>
</html>