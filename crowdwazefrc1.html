<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>è”æè§’äººæµ + å¤©æ°£ + Waze</title>
<style>
body { font-family: sans-serif; padding: 20px; }
#map { width: 100%; height: 300px; margin-top: 10px; }
select, button { padding: 8px; font-size: 16px; }
.section { margin-bottom: 20px; }
</style>
</head>
<body>
<div class="section">
<h3>ğŸŒ¦ å¤©æ°£è³‡è¨Š</h3>
<div id="weather">è¼‰å…¥ä¸­...</div>
</div>

<div class="section">
<h3>ğŸ‘¥ äººæµæƒ…æ³</h3>
<select id="location">
<option>D2 Place Two</option>
<option>V Walk</option>
<option>è”æè§’æ¸¯éµç«™</option>
<option>é•·æ²™ç£å»£å ´</option>
<option>å®‡æ™´åŒ¯å•†å ´</option>
</select>
<div id="crowd">ç›®å‰äººæµï¼šæœªçŸ¥</div>
</div>

<div id="map">
<iframe id="wazeFrame" width="100%" height="300" frameborder="0" src=""></iframe>
</div>

<script>
const apiBase = "https://tinyl-disk-0d7b.ctakwah.workers.dev";
const locSelect = document.getElementById("location");
const crowdDiv = document.getElementById("crowd");
const weatherDiv = document.getElementById("weather");
const wazeFrame = document.getElementById("wazeFrame");

async function fetchWeather() {
try {
const res = await fetch(`${apiBase}?mode=weather`);
const data = await res.json();
const temp = data.rh.value + "Â°C";
const rain = data.rainfall.find(r => r.place.includes("è”æè§’"))?.max || "0";
const warning = data.warn?.details?.map(w => w.contents[0].text).join("ï¼›") || "ç„¡è­¦å‘Š";

weatherDiv.innerHTML = `
ğŸŒ¡ æº«åº¦ï¼š${temp}<br/>
â˜”ï¸ é™é›¨é‡ï¼š${rain} mm<br/>
âš ï¸ è­¦å‘Šï¼š${warning}
`;

if (parseFloat(rain) > 5) {
const utterance = new SpeechSynthesisUtterance(`æ³¨æ„ï¼šè”æè§’åœ°å€é™é›¨é‡ç‚º ${rain} æ¯«ç±³ï¼Œè«‹æ³¨æ„å®‰å…¨`);
utterance.lang = 'zh-HK';
speechSynthesis.speak(utterance);
}
} catch (e) {
weatherDiv.innerText = "ç„¡æ³•è¼‰å…¥å¤©æ°£è³‡è¨Š";
}
}

async function fetchCrowd() {
const location = locSelect.value;
try {
const res = await fetch(`${apiBase}?mode=crowd&location=${encodeURIComponent(location)}`);
const data = await res.json();
const place = data[0];
const status = place.populartimes?.currentPopularity || "æœªçŸ¥";
crowdDiv.innerText = `ç›®å‰äººæµï¼š${status}`;
} catch (e) {
crowdDiv.innerText = "ç›®å‰äººæµï¼šè¼‰å…¥å¤±æ•—";
}
}

function updateMap() {
const loc = locSelect.value;
const maps = {
"D2 Place Two": [22.335, 114.154],
"V Walk": [22.336, 114.151],
"è”æè§’æ¸¯éµç«™": [22.3366, 114.149],
"é•·æ²™ç£å»£å ´": [22.3363, 114.152],
"å®‡æ™´åŒ¯å•†å ´": [22.3348, 114.148]
};
const [lat, lon] = maps[loc] || [22.335, 114.154];
wazeFrame.src = `https://embed.waze.com/iframe?zoom=16&lat=${lat}&lon=${lon}&pin=1`;
}

locSelect.addEventListener("change", () => {
fetchCrowd();
updateMap();
});

fetchWeather();
fetchCrowd();
updateMap();
</script>
</body>
</html>