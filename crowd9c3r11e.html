<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¯¦æ™‚äººæµæŸ¥è©¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
font-family: sans-serif;
padding: 10px;
font-size: 18px;
line-height: 1.6;
}
#map {
height: 300px;
margin-top: 10px;
}
input, button {
font-size: 18px;
padding: 6px;
margin: 5px 0;
}
#status {
margin-top: 10px;
font-weight: bold;
}
</style>
</head>
<body>
<h2>ğŸ“ å¯¦æ™‚äººæµæŸ¥è©¢</h2>
<input id="queryInput" type="text" placeholder="è«‹è¼¸å…¥åœ°é»ï¼Œä¾‹å¦‚ï¼šé¦™æ¸¯åœ‹éš›æ©Ÿå ´" />
<button onclick="search()">æŸ¥è©¢</button>
<div id="status"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map;

async function search() {
const query = document.getElementById("queryInput").value.trim();
if (!query) {
alert("è«‹è¼¸å…¥åœ°é»åç¨±");
return;
}

document.getElementById("status").innerText = "ğŸ”„ æŸ¥è©¢ä¸­â€¦";

try {
const res = await fetch(`https://round-bonus-0273.ctakwah.workers.dev/?query=${encodeURIComponent(query)}`);
if (!res.ok) throw new Error("æŸ¥è©¢å¤±æ•—");

const data = await res.json();

if (!data.success) {
document.getElementById("status").innerText = `âŒ ${data.message || "æ‰¾ä¸åˆ°è³‡æ–™"}`;
speak(`æ‰¾ä¸åˆ° ${query} çš„äººæµè³‡è¨Š`);
return;
}

const { query_used, location, popular_times } = data;
const now = new Date();
const hour = now.getHours();
const weekday = now.getDay(); // Sunday = 0
const dayIndex = weekday === 0 ? 6 : weekday - 1; // Convert to Monday = 0
const hourData = popular_times?.[dayIndex]?.data || [];
const level = hourData[hour];

document.getElementById("status").innerText = `ğŸ“ ${query_used}ï¼šç›®å‰äººæµç´„ç‚º ${level ?? "æœªçŸ¥"}%`;
speak(`${query_used} ç¾åœ¨äººæµå¤§ç´„ ${level ?? "æœªçŸ¥"}%`);

if (location?.lat && location?.lng) {
if (!map) {
map = L.map("map").setView([location.lat, location.lng], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
attribution: 'Â© OpenStreetMap',
}).addTo(map);
} else {
map.setView([location.lat, location.lng], 16);
}
L.marker([location.lat, location.lng]).addTo(map).bindPopup(query_used).openPopup();
}
} catch (e) {
console.error(e);
document.getElementById("status").innerText = "â— ç„¡æ³•æŸ¥è©¢äººæµï¼Œè«‹ç¨å¾Œå†è©¦";
speak("ç„¡æ³•æŸ¥è©¢äººæµè³‡æ–™");
}
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);
}

// âœ… é é¢ä¸€é–‹è‡ªå‹•æŸ¥ã€Œé¦™æ¸¯åœ‹éš›æ©Ÿå ´ã€
window.onload = () => {
document.getElementById("queryInput").value = "é¦™æ¸¯åœ‹éš›æ©Ÿå ´";
search();
};
</script>
</body>
</html>
