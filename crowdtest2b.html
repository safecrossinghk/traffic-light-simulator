<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å³æ™‚é›¨é‡è‡¨è¿‘é å ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
#map { height: 60vh; }
#info { padding: 1em; background: yellow; text-align: center; font-weight: bold; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
</head>
<body>
<div id="info">â³ æ­£åœ¨è¼‰å…¥ä½ çš„ä½ç½®èˆ‡é›¨é‡è³‡æ–™â€¦</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);
}

function parseCSV(text) {
const lines = text.trim().split('\n');
const data = [];
for (let i = 1; i < lines.length; i++) {
const parts = lines[i].split(',');
const lat = parseFloat(parts[0]);
const lon = parseFloat(parts[1]);
const rain = parseFloat(parts[2]);
data.push({ lat, lon, rain });
}
return data;
}

function findNearestGrid(userLat, userLon, gridData) {
let minDist = Infinity;
let nearest = null;
for (const point of gridData) {
const d = Math.pow(userLat - point.lat, 2) + Math.pow(userLon - point.lon, 2);
if (d < minDist) {
minDist = d;
nearest = point;
}
}
return nearest;
}

async function run() {
const res = await fetch("https://data.weather.gov.hk/weatherAPI/hko_data/gridded_rainfall_nowcast/Chi.csv"); // æ”¹ç‚ºæœ€æ–° CSV API é€£çµ
const text = await res.text();
const gridData = parseCSV(text);

navigator.geolocation.getCurrentPosition(pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;

const map = L.map('map').setView([lat, lon], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);
L.marker([lat, lon]).addTo(map).bindPopup("ä½ çš„ä½ç½®").openPopup();

const nearest = findNearestGrid(lat, lon, gridData);
const msg = `ğŸŒ§ï¸ ä½ é™„è¿‘æœªä¾†åŠå°æ™‚é›¨é‡é æ¸¬ï¼šç´„ ${nearest.rain.toFixed(1)} mm`;
document.getElementById("info").innerText = msg;

if (nearest.rain > 5) {
speak("ä½ é™„è¿‘æœªä¾†å¯èƒ½æœ‰å¤§é›¨ï¼Œè«‹ç•™æ„å¤©æ°£è®ŠåŒ–");
}
}, () => {
document.getElementById("info").innerText = "âŒ ç„¡æ³•å–å¾—ä½ çš„ä½ç½®";
});
}

run();
</script>
</body>
</html>