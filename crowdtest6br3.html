<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<title>é¦™æ¸¯é›¨é‡è‡¨è¿‘é æ¸¬</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: sans-serif; text-align: center; background: #eef6ff; margin: 0; padding: 0; }
#map { height: 300px; width: 90%; margin: 10px auto; border-radius: 10px; }
.status { margin-top: 10px; font-size: 16px; }
.loading { color: #888; }
.error { color: red; }
.success { color: green; font-weight: bold; }
</style>
</head>
<body>
<h2>â˜” é¦™æ¸¯é›¨é‡è‡¨è¿‘é æ¸¬</h2>
<div id="map"></div>
<div class="status loading" id="status">ğŸ“ æ­£åœ¨å®šä½ä¸­...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const statusEl = document.getElementById('status');
let map, marker;

function updateStatus(msg, className = "loading") {
statusEl.textContent = msg;
statusEl.className = `status ${className}`;
}

function fetchRainForecast(lat, lon, retryCount = 0) {
const workerURL = `https://crowdtest6br2.ctakwah.workers.dev/?lat=${lat}&lon=${lon}`;
updateStatus("ğŸŒ§ï¸ æ­£åœ¨è¼‰å…¥é æ¸¬è³‡æ–™...");

fetch(workerURL)
.then(res => {
if (!res.ok) throw new Error(`Worker éŒ¯èª¤ä»£ç¢¼ ${res.status}`);
return res.json();
})
.then(data => {
if (data.rainExpected) {
updateStatus(`âš ï¸ ${data.message}ï¼ˆ${data.immediateRain} mmï¼‰`, "success");
} else {
updateStatus(`âœ… ${data.message}`, "success");
}
})
.catch(err => {
if (retryCount < 2) {
updateStatus(`ğŸ” å˜—è©¦é‡æ–°å–å¾—è³‡æ–™ä¸­...`, "loading");
setTimeout(() => fetchRainForecast(lat, lon, retryCount + 1), 2000);
} else {
updateStatus(`âš ï¸ ç„¡æ³•å–å¾—é æ¸¬è³‡æ–™ï¼š${err.message}`, "error");
}
});
}

if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;

map = L.map('map').setView([lat, lon], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19
}).addTo(map);

marker = L.marker([lat, lon]).addTo(map)
.bindPopup("ä½ çš„ä½ç½®").openPopup();

fetchRainForecast(lat, lon);
}, () => {
updateStatus("âŒ ç„¡æ³•å–å¾—å®šä½", "error");
});
} else {
updateStatus("âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½", "error");
}
</script>
</body>
</html>