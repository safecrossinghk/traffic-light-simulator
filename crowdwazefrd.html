<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>è”æè§’äººæµ + Waze + å¤©æ°£é å ±</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; padding: 1rem; }
h2 { margin-top: 2rem; }
iframe { width: 100%; height: 300px; border: none; }
select, button { font-size: 1rem; padding: 5px; }
</style>
</head>
<body>
<h2>ğŸŒ¤ï¸ å¤©æ°£è³‡è¨Š</h2>
<div id="weather">è¼‰å…¥ä¸­...</div>

<h2>ğŸš¶â€â™‚ï¸ äººæµè³‡è¨Š</h2>
<label for="locationSelect">é¸æ“‡äººæµåœ°é»ï¼š</label>
<select id="locationSelect">
<option>D2 Place Two</option>
<option>è¥¿ä¹é¾é«˜éµç«™</option>
<option>ç¾…æ¹–ç«™</option>
<option>è½é¦¬æ´²ç«™</option>
<option>é¦™æ¸¯åœ‹éš›æ©Ÿå ´</option>
</select>
<div id="crowd">è¼‰å…¥ä¸­...</div>

<h2>ğŸ—º Waze è·¯æ³åœ°åœ–</h2>
<iframe id="wazeMap" allowfullscreen></iframe>

<script>
const workerURL = "https://crowdwazefr2.ctakwah.workers.dev";

async function fetchWeather() {
try {
const res = await fetch(`${workerURL}?mode=weather`);
const data = await res.json();
if (data.error) throw new Error(data.detail);

const rain = data.rain || "ä¸è©³";
const temp = data.temperature + "Â°C";
const warning = Object.keys(data.warnings).length > 0
? "âš ï¸ æœ‰å¤©æ°£è­¦å‘Š"
: "â˜€ï¸ ç„¡å¤©æ°£è­¦å‘Š";

document.getElementById("weather").innerText =
`è”æè§’æ°£æº«ï¼š${temp}ï½œé›¨é‡ï¼š${rain}mmï½œ${warning}`;

if (parseFloat(rain) > 5) {
const audio = new SpeechSynthesisUtterance("âš ï¸ è”æè§’ç¾æ™‚é›¨é‡è¶…é 5 æ¯«ç±³ï¼Œè«‹æ³¨æ„å®‰å…¨ã€‚");
audio.lang = "zh-HK";
speechSynthesis.speak(audio);
}
} catch (err) {
document.getElementById("weather").innerText = "ç„¡æ³•è¼‰å…¥å¤©æ°£è³‡è¨Š";
}
}

async function fetchCrowd(location) {
try {
const res = await fetch(`${workerURL}?mode=crowd&location=${encodeURIComponent(location)}`);
const data = await res.json();
if (data.error) throw new Error(data.detail);

const now = new Date();
const day = now.getDay(); // Sunday = 0
const hour = now.getHours();

const today = data.popularTimes?.[day === 0 ? 6 : day - 1];
const crowd = today?.data?.[hour] ?? "ä¸è©³";

document.getElementById("crowd").innerText = `ç›®å‰äººæµï¼š${crowd} äºº`;

const utter = new SpeechSynthesisUtterance(`${location}ï¼Œç›®å‰äººæµå¤§ç´„ ${crowd} äºº`);
utter.lang = "zh-HK";
speechSynthesis.speak(utter);
} catch (err) {
document.getElementById("crowd").innerText = "ç„¡æ³•è¼‰å…¥äººæµè³‡è¨Š";
}
}

function updateWazeMap(location) {
const coords = {
"D2 Place Two": [22.3379, 114.1531],
"è¥¿ä¹é¾é«˜éµç«™": [22.3047, 114.1619],
"ç¾…æ¹–ç«™": [22.5290, 114.1154],
"è½é¦¬æ´²ç«™": [22.5077, 114.0788],
"é¦™æ¸¯åœ‹éš›æ©Ÿå ´": [22.3080, 113.9185]
};
const [lat, lon] = coords[location] || [22.3379, 114.1531];
document.getElementById("wazeMap").src =
`https://embed.waze.com/iframe?zoom=14&lat=${lat}&lon=${lon}&pin=1`;
}

// åˆå§‹è¼‰å…¥
const select = document.getElementById("locationSelect");
fetchWeather();
fetchCrowd(select.value);
updateWazeMap(select.value);

// åœ°é»æ”¹è®Šæ™‚æ›´æ–°
select.addEventListener("change", () => {
const loc = select.value;
fetchCrowd(loc);
updateWazeMap(loc);
});
</script>
</body>
</html>