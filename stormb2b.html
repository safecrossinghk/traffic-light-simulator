<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>AIé¢¨æš´æ¶ˆæ¯</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
#map { height: 50vh; }
#chart { width:100%; height:300px; }
#activity { margin:1em; }
#advice { margin:1em; font-size:1.1em; }
</style>
</head>
<body>

<h1 style="text-align:center; margin:1em 0;">AIé¢¨æš´æ¶ˆæ¯</h1>
<div id="map"></div>
<canvas id="chart"></canvas>

<div id="activity">
<h3>ğŸ“… åŠ å…¥ä½ çš„æ´»å‹•æ™‚é–“èˆ‡åœ°é»</h3>
<label>æ—¥æœŸï¼æ™‚é–“ï¼š <input type="datetime-local" id="actTime"></label><br>
<label>åœ°é»ï¼ˆå¦‚ï¼šè§€å¡˜ã€é•·æ´²ï¼‰ï¼š <input type="text" id="actLoc"></label><br>
<button id="checkBtn">åˆ†æå»ºè­°</button>
</div>
<div id="advice"></div>

<!-- JS Libraries -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const workerURL = 'https://stormb2-api.ctakwah.workers.dev'; // æ”¹æˆä½  Cloudflare Worker å¯¦éš›ç¶²å€

async function loadStormData() {
try {
const res = await fetch(workerURL);
const json = await res.json();

// æ¨¡æ“¬è§£ææ ¼å¼ï¼ˆæ ¹æ“šå¯¦éš› GLO-TCTrackX çµæ§‹èª¿æ•´ï¼‰
const track = json.tracks[0]; // å‡è¨­å–ç¬¬ä¸€å€‹é¢±é¢¨
const latlngs = track.positions.map(p => [p.latitude, p.longitude]);

// åœ°åœ–é¡¯ç¤º
const map = L.map('map').setView([20, 120], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap'
}).addTo(map);
const polyline = L.polyline(latlngs, {color:'red'}).addTo(map);
latlngs.forEach((latlng, i) => {
L.circleMarker(latlng, {radius:4, color:'red'}).bindPopup(`Time: ${track.positions[i].time}`).addTo(map);
});
L.marker([22.3,114.2]).bindPopup('é¦™æ¸¯').addTo(map);
map.fitBounds(polyline.getBounds());

// æ©Ÿç‡åœ–å¯æ”¹ç‚ºä½¿ç”¨ AI æˆ–æ¨¡æ“¬æ•¸æ“š
const ctx = document.getElementById('chart').getContext('2d');
new Chart(ctx, {
type: 'line',
data: {
labels: track.positions.map(p => p.time),
datasets: [
{label:'é¢¨é€Ÿ (km/h)', data: track.positions.map(p=>p.windSpeed), borderColor:'orange', fill:false}
]
},
options: {
scales: { y: { beginAtZero:true } },
plugins: { title:{ display:true, text:'é¢¨æš´é¢¨é€Ÿé æ¸¬åœ–' } }
}
});

} catch (e) {
console.error('è¼‰å…¥å¤±æ•—', e);
}
}

loadStormData();

// æ´»å‹•åˆ†æåŠŸèƒ½ï¼ˆæ¨¡æ“¬ç‰ˆæœ¬ï¼‰
document.getElementById('checkBtn').addEventListener('click', () => {
const t = new Date(document.getElementById('actTime').value);
const loc = document.getElementById('actLoc').value.trim();
if (!t || !loc) {
alert('è«‹è¼¸å…¥æ—¥æœŸæ™‚é–“èˆ‡åœ°é»');
return;
}
const msg = `ä½ å®‰æ’æ–¼ ${t.toLocaleString()} åœ¨ã€Œ${loc}ã€é€²è¡Œæ´»å‹•ã€‚\nè«‹åƒè€ƒåœ–ä¸­é¢¨æš´é¢¨é€Ÿèˆ‡é æ¸¬è·¯å¾‘å†ä½œæ±ºå®šã€‚`;
document.getElementById('advice').innerText = msg;
});
</script>

</body>
</html>