<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å³æ™‚äººæµæŸ¥è©¢ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<style>
body { font-family: sans-serif; padding: 20px; }
.location { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
.status { font-weight: bold; }
</style>
</head>
<body>
<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢ï¼ˆäº”å€‹åœ°é»ï¼‰</h2>
<div id="results"></div>

<script>
const locations = [
"èƒç£è¥¿ç«™",
"æ—ºè§’æœ—è±ªåŠ",
"æ·±æ°´åŸ—åœ°éµç«™",
"å°–æ²™å’€æµ·æ¸¯åŸ",
"ä¸­ç’°äº¤æ˜“å»£å ´"
];
const API_KEY = "MWE3NWNmMzFjZWNiNGMxMDlhNGNhNDFjNTY3ZjZkMTB8NzY5ZGY0MGQ0Zg";

function normalizePopularTimes(arr) {
if (!Array.isArray(arr)) return null;
const map = {};
arr.forEach(dayObj => {
const name = dayObj.day_text;
map[name] = {};
(dayObj.popular_times || []).forEach(item => {
map[name][item.hour] = item.percentage;
});
});
return map;
}

function speak(text, lang) {
const u = new SpeechSynthesisUtterance(text);
u.lang = lang;
window.speechSynthesis.speak(u);
}

async function fetchPopularTimes(place) {
try {
const res1 = await fetch(`https://api.app.outscraper.com/maps/search-v2?query=${encodeURIComponent(place)}&limit=1&language=zh&region=hk`, {
headers: { "X-API-KEY": API_KEY }
});
const j1 = await res1.json();
const id = j1.id;
if (!id) throw new Error("æŸ¥è©¢ ID å¤±æ•—");

await new Promise(r => setTimeout(r, 3000));

const res2 = await fetch(`https://api.outscraper.cloud/requests/${id}`);
const j2 = await res2.json();
const raw = j2.data?.[0]?.[0]?.popular_times;
return normalizePopularTimes(raw);
} catch (err) {
console.warn(`âŒ API æŸ¥è©¢éŒ¯èª¤ï¼š${place}`, err);
return null;
}
}

async function displayAll() {
const now = new Date();
const weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][now.getDay()];
const hour = now.getHours();
const resultDiv = document.getElementById("results");

console.log("ğŸ” é–‹å§‹æŸ¥è©¢å³æ™‚äººæµ...");

for (const place of locations) {
const el = document.createElement("div");
el.className = "location";
el.innerHTML = `<h3>${place}</h3><div class="status">â³ è¼‰å…¥ä¸­...</div>`;
resultDiv.appendChild(el);

const data = await fetchPopularTimes(place);
if (data) {
const crowd = data[weekday]?.[hour];
const status = crowd !== undefined
? `ç¾æ™‚äººæµï¼š${crowd}%`
: "ğŸ” æ‰¾ä¸åˆ°å³æ™‚äººæµè³‡æ–™";
el.querySelector(".status").innerText = status;

const lang = navigator.language.startsWith("zh") ? "zh-HK" : "en-US";
const spoken = lang === "zh-HK"
? `${place} ç¾æ™‚äººæµä¿‚ ${crowd !== undefined ? crowd + " ç™¾åˆ†æ¯”" : "ç„¡è³‡æ–™"}`
: `Current crowd level at ${place} is ${crowd !== undefined ? crowd + " percent" : "not available"}`;
speak(spoken, lang);

console.log(`${place} â†’ âœ… ${status}`);
} else {
el.querySelector(".status").innerText = "âš ï¸ æŸ¥è©¢å¤±æ•—æˆ–ç„¡ popular_times è³‡æ–™";
console.warn(`${place} â†’ âŒ æŸ¥è©¢å¤±æ•—`);
}
}
}

displayAll();
</script>
</body>
</html>