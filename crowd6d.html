<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å³æ™‚äººæµæŸ¥è©¢ï¼ˆGoogle Maps IDï¼‰</title>
<style>
body { font-family: sans-serif; padding: 20px; }
.location { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
.status { font-weight: bold; padding: 5px; border-radius: 4px; display: inline-block; }
.low { background-color: #d4edda; color: #155724; }
.medium { background-color: #fff3cd; color: #856404; }
.high { background-color: #f8d7da; color: #721c24; }
.error { color: #dc3545; }
</style>
</head>
<body>
<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢ï¼ˆ5å€‹åœ°é» - Google Maps IDï¼‰</h2>
<div id="results"></div>

<script>
const API_KEY = "MWE3NWNmMzFjZWNiNGMxMDlhNGNhNDFjNTY3ZjZkMTB8NzY5ZGY0MGQ0Zg";
const LOCATIONS = [
{ name: "èƒç£è¥¿ç«™", placeId: "ChIJ_QlQqWcABDQRmVq40G0YtP8" },
{ name: "æ—ºè§’æœ—è±ªåŠ", placeId: "ChIJC_a1xpUBAzQRfnglRAVPe1g" },
{ name: "æ·±æ°´åŸ—åœ°éµç«™", placeId: "ChIJv02y6fsABDQR3eEpg4kBTfE" },
{ name: "å°–æ²™å’€æµ·æ¸¯åŸ", placeId: "ChIJa-LbEXgABDQRAjYroS9WAZo" },
{ name: "ä¸­ç’°äº¤æ˜“å»£å ´", placeId: "ChIJWeX_XpcABDQRg9-pVHgqs_U" }
];

const resultDiv = document.getElementById("results");

async function fetchPopularTimes(placeId, retries = 2) {
const searchUrl = `https://api.app.outscraper.com/maps/search-v2?query=${placeId}&place_id_only=true&language=zh&region=hk`;
try {
const response = await fetch(searchUrl, {
headers: { "X-API-KEY": API_KEY }
});
const data = await response.json();
const id = data.id;
if (!id) throw new Error("æœªèƒ½å–å¾—æŸ¥è©¢ ID");

// ç­‰å¾… 5 ç§’å–å¾—çµæœ
await new Promise(r => setTimeout(r, 5000));

const resultUrl = `https://api.outscraper.cloud/requests/${id}`;
const finalRes = await fetch(resultUrl);
const finalData = await finalRes.json();
const placeData = finalData.data?.[0]?.[0];

return placeData?.popular_times || null;
} catch (err) {
if (retries > 0) {
console.warn(`ğŸ” Retry fetch for ${placeId}`);
return fetchPopularTimes(placeId, retries - 1);
}
throw err;
}
}

function getTodayHourData(popularTimes) {
const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const today = days[new Date().getDay()];
const hour = new Date().getHours();
return popularTimes?.[today]?.[hour];
}

function getColorClass(value) {
if (value <= 30) return "low";
if (value <= 70) return "medium";
return "high";
}

async function displayAll() {
console.log("ğŸ” é–‹å§‹æŸ¥è©¢å³æ™‚äººæµ...");
resultDiv.innerHTML = "";

for (const loc of LOCATIONS) {
const el = document.createElement("div");
el.className = "location";
el.innerHTML = `<h3>${loc.name}</h3><div class="status">ğŸ”„ è¼‰å…¥ä¸­â€¦</div>`;
resultDiv.appendChild(el);

try {
const popData = await fetchPopularTimes(loc.placeId);
const value = getTodayHourData(popData);

if (value !== undefined) {
const colorClass = getColorClass(value);
el.querySelector(".status").innerHTML = `ç¾æ™‚äººæµï¼š<span class="${colorClass}">${value}%</span>`;
} else {
el.querySelector(".status").innerHTML = `<span class="error">âš ï¸ æ­¤åœ°é»æš«ç„¡äººæµè³‡æ–™</span>`;
}
} catch (err) {
el.querySelector(".status").innerHTML = `<span class="error">âŒ æŸ¥è©¢å¤±æ•—</span>`;
console.error(`${loc.name} â†’ æŸ¥è©¢å¤±æ•—ï¼š`, err);
}
}
}

displayAll();
setInterval(displayAll, 5 * 60 * 1000); // æ¯ 5 åˆ†é˜è‡ªå‹•æ›´æ–°
</script>
</body>
</html>