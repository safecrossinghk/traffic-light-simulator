<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é›¨é‡é æ¸¬æç¤º</title>
<script>
const workerUrl = "https://crowdtest3d.ctakwah.workers.dev/"; // â† æ”¹æˆä½ çš„ Worker é€£çµ

function getNearestPoint(lat, lon, data) {
let nearest = null, minDist = Infinity;
for (const row of data) {
const [station, rlat, rlon, rain] = row;
const d = Math.sqrt((lat - rlat)**2 + (lon - rlon)**2);
if (d < minDist) {
minDist = d;
nearest = { station, rain: parseFloat(rain) };
}
}
return nearest;
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = "zh-HK"; // ä¸­æ–‡ï¼ˆé¦™æ¸¯ï¼‰ï¼Œå¯æ”¹ "zh-CN" æ™®é€šè©± æˆ– "en-US"
window.speechSynthesis.speak(msg);
}

async function fetchRainData(lat, lon) {
try {
const res = await fetch(workerUrl);
const text = await res.text();
const rows = text.trim().split("\n").slice(2).map(line => {
const parts = line.split(",");
return [parts[0], parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3])];
});

const nearest = getNearestPoint(lat, lon, rows);
document.getElementById("output").textContent = `åœ°é»ï¼š${nearest.station}ï¼Œé æ¸¬é›¨é‡ï¼š${nearest.rain} æ¯«ç±³`;

if (nearest.rain > 5) {
speak("âš ï¸ æœªä¾†åŠå°æ™‚å¯èƒ½æœ‰å¤§é›¨ï¼Œè«‹å°å¿ƒã€‚");
}
} catch (e) {
document.getElementById("output").textContent = "âŒ ç„¡æ³•è®€å–é›¨é‡è³‡æ–™";
}
}

function updateLocationAndData() {
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;

// é¡¯ç¤ºåœ°åœ–æ¨™è¨˜
const map = L.map('map').setView([lat, lon], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([lat, lon]).addTo(map).bindPopup("ä½ çš„ä½ç½®").openPopup();

fetchRainData(lat, lon);
});
}
}

window.onload = () => {
updateLocationAndData();
setInterval(updateLocationAndData, 5 * 60 * 1000); // æ¯ 5 åˆ†é˜æ›´æ–°
};
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<h2>ğŸŒ§ï¸ é¦™æ¸¯é›¨é‡é æ¸¬æç¤º</h2>
<div id="output">è®€å–ä¸­â€¦</div>
<div id="map" style="height: 400px; margin-top: 1em;"></div>
</body>
</html>