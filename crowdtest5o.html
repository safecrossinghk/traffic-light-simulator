<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸŒ§ï¸ é¦™æ¸¯é›¨é‡è‡¨è¿‘é æ¸¬</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
font-family: "Helvetica Neue", sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
text-align: center;
}
h1 {
font-size: 1.4em;
margin: 1em 0 0.5em;
}
#map {
height: 300px;
margin: 0 10px;
border-radius: 8px;
border: 1px solid #ccc;
}
#rain-alert {
margin: 1em;
font-size: 1.2em;
font-weight: bold;
}
</style>
</head>
<body>
<h1>ğŸŒ‚ é¦™æ¸¯é›¨é‡è‡¨è¿‘é æ¸¬</h1>
<div id="map"></div>
<div id="rain-alert">â³ æ­£åœ¨è®€å–é æ¸¬è³‡æ–™...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest5o.ctakwah.workers.dev/'; // â¬…ï¸ è«‹æ”¹æˆä½ è‡ªå·±çš„ Worker ç¶²å€

const map = L.map('map').setView([22.3, 114.2], 11); // é¦™æ¸¯é è¨­ä½ç½®
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker;

// å˜—è©¦å–å¾—å®šä½
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
map.setView([lat, lon], 13);
if (marker) marker.remove();
marker = L.marker([lat, lon]).addTo(map);
fetchForecast(lat, lon);
},
err => {
// å®šä½å¤±æ•—æ™‚ fallback åˆ°é¦™æ¸¯ä¸­å¿ƒ
console.warn("å®šä½å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½ç½®");
const lat = 22.3;
const lon = 114.2;
map.setView([lat, lon], 11);
marker = L.marker([lat, lon]).addTo(map);
fetchForecast(lat, lon);
},
{ enableHighAccuracy: true }
);
} else {
alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
}

function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
const alertDiv = document.getElementById('rain-alert');
if (data && data.forecast) {
const values = data.forecast.filter(v => typeof v === 'number');
const futureRain = values.slice(1, 6); // 6~30åˆ†é˜ï¼ˆç•¥éç¬¬ä¸€å€‹ï¼š0~6åˆ†é˜ï¼‰

const threshold = 2.0; // mm é–€æª»
const willRain = futureRain.some(val => val > threshold);

if (willRain) {
alertDiv.innerText = "âš ï¸ å³å°‡æœ‰é›¨ï¼Œè«‹æº–å‚™é›¨å…·";
speak("Rain expected in the next 30 minutes.");
} else {
alertDiv.innerText = "â˜€ï¸ æœªæœ‰é¡¯è‘—é™é›¨é æ¸¬";
}
} else {
alertDiv.innerText = "âš ï¸ ç„¡æ³•è®€å–é æ¸¬è³‡æ–™";
}
})
.catch(err => {
console.error("è®€å–é æ¸¬éŒ¯èª¤", err);
document.getElementById('rain-alert').innerText = "âš ï¸ ç„¡æ³•å–å¾—é æ¸¬è³‡æ–™";
});
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'en-US';
speechSynthesis.speak(msg);
}
</script>
</body>
</html>