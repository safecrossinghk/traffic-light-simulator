<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ“ è”æè§’äººæµ + Waze åœ°åœ–</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
margin: 0;
padding: 1em;
background: #f4f4f4;
}
h2 { text-align: center; }
select {
width: 100%;
padding: 1em;
margin-bottom: 1em;
font-size: 1.1em;
border: none;
background-color: #007bff;
color: white;
border-radius: 5px;
}
#result {
background: white;
padding: 1em;
border-radius: 5px;
margin-top: 1em;
box-shadow: 0 0 3px rgba(0,0,0,0.1);
font-size: 1.1em;
}
iframe {
width: 100%;
height: 55vh;
border: none;
border-radius: 10px;
margin-top: 1em;
}
.busy { color: red; font-weight: bold; }
.normal { color: green; font-weight: bold; }
#weather {
font-size: 1em;
margin-bottom: 1em;
text-align: center;
}
</style>
</head>
<body>

<h2>ğŸ“ è”æè§’äººæµ + Waze åœ°åœ–</h2>
<div id="weather">â›… æ­£åœ¨è¼‰å…¥å¤©æ°£è³‡è¨Š...</div>

<!-- ä¸‹æ‹‰é¸å–®å–ä»£æŒ‰éˆ• -->
<select id="locationSelect" onchange="onLocationChange(this.value)">
  <option value="">è«‹é¸æ“‡åœ°é»æŸ¥è©¢</option>
  <option value="è”æè§’ç«™å‡ºå£ A">è”æè§’ç«™å‡ºå£ A</option>
  <option value="D2 Place">D2 Place</option>
  <option value="é•·æ²™ç£å»£å ´">é•·æ²™ç£å»£å ´</option>
  <option value="D2 Place Two">D2 Place Two</option>
  <option value="æ³“æ™¯åŒ¯">æ³“æ™¯åŒ¯</option>
</select>

<div id="result">ğŸ” è«‹é¸æ“‡ä¸Šæ–¹åœ°é»ä»¥æŸ¥è©¢ã€‚</div>
<iframe id="wazeMap" src=""></iframe>

<script>
const wazeUrls = {
"è”æè§’ç«™å‡ºå£ A": "https://embed.waze.com/iframe?zoom=17&lat=22.338611&lon=114.149444&pin=1",
"D2 Place": "https://embed.waze.com/iframe?zoom=17&lat=22.338336&lon=114.149792&pin=1",
"é•·æ²™ç£å»£å ´": "https://embed.waze.com/iframe?zoom=17&lat=22.337858&lon=114.152069&pin=1",
"D2 Place Two": "https://embed.waze.com/iframe?zoom=17&lat=22.338877&lon=114.149200&pin=1",
"æ³“æ™¯åŒ¯": "https://embed.waze.com/iframe?zoom=17&lat=22.336136&lon=114.155181&pin=1"
};

async function fetchWithRetry(query, retries = 3, delay = 800) {
for (let i = 0; i < retries; i++) {
try {
const res = await fetch("https://tiny-disk-0d7b.ctakwah.workers.dev/?query=" + encodeURIComponent(query));
if (!res.ok) throw new Error("HTTP error " + res.status);
const data = await res.json();
if (!data.success) throw new Error(data.message || "æœªçŸ¥éŒ¯èª¤");
return data;
} catch (err) {
if (i === retries - 1) throw err;
await new Promise(resolve => setTimeout(resolve, delay));
}
}
}

async function queryLocation(name) {
document.getElementById("result").textContent = "â³ æ­£åœ¨æŸ¥è©¢ä¸­...";
document.getElementById("wazeMap").src = wazeUrls[name];

try {
const data = await fetchWithRetry(name);
let percentage = null;
if (Array.isArray(data.popular_times)) {
const live = data.popular_times.find(d => d.day === "live");
if (live && typeof live.percentage === "number") {
percentage = live.percentage;
}
}

if (percentage === null) {
document.getElementById("result").textContent = "âš ï¸ ç„¡æ³•å–å¾—å³æ™‚äººæµè³‡æ–™ã€‚";
return;
}

let label = "ğŸŸ¢ åå°‘";
if (percentage >= 80) label = "ğŸ”´ éå¸¸ç¹å¿™";
else if (percentage >= 20) label = "ğŸŸ¡ æ­£å¸¸";

document.getElementById("result").innerHTML =
`ğŸ“Œ åœ°é»ï¼š${name}<br>ğŸ‘¥ ç¾æ™‚äººæµï¼š<span class="${percentage >= 70 ? 'busy' : 'normal'}">${label}ï¼ˆç´„ ${percentage}%ï¼‰</span>`;

const msg = new SpeechSynthesisUtterance(`${name} ç¾æ™‚äººæµï¼š${label}`);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);

} catch (e) {
console.error(e);
document.getElementById("result").textContent = "âŒ æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
}
}

function onLocationChange(value) {
if (value) queryLocation(value);
}

async function loadWeather() {
  try {
    const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc");
    const data = await res.json();

    const temp = data.temperature.data.find(d => d.place === "é¦™æ¸¯å¤©æ–‡å°");
    const humidity = data.humidity.data[0];

    const iconCode = data.icon[0];
    const iconUrl = `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${iconCode}.png`;

    let warning = "â˜ ç„¡ç‰¹åˆ¥å¤©æ°£è­¦å‘Š";
    if (Array.isArray(data.warningMessage)) {
      warning = data.warningMessage.join("ï¼Œ");
    } else if (typeof data.warningMessage === "string" && data.warningMessage.trim() !== "") {
      warning = data.warningMessage;
    }

    document.getElementById("weather").innerHTML = `
      <img src="${iconUrl}" alt="å¤©æ°£åœ–ç¤º" style="height:24px;vertical-align:middle;"> 
      å¤©æ°£ï¼š${iconCode} ï½œ æº«åº¦ ${temp?.value || 'æœªçŸ¥'}Â°C ï½œ æ¿•åº¦ ${humidity?.value || 'æœªçŸ¥'}% <br>
      ğŸ”” ${warning}`;
  } catch (e) {
    console.error(e);
    document.getElementById("weather").textContent = "âš ï¸ ç„¡æ³•è¼‰å…¥å¤©æ°£è³‡æ–™ã€‚";
  }
}

loadWeather();
</script>

</body>
</html>