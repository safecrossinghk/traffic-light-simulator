<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å³æ™‚äººæµæŸ¥è©¢ï¼ˆPlace ID ç‰ˆï¼‰</title>
<style>
body { font-family: sans-serif; padding: 20px; }
.location { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
.status { font-weight: bold; font-size: 1.2em; }
.green { color: green; }
.yellow { color: orange; }
.red { color: red; }
@media (max-width: 600px) {
h2 { font-size: 1.2em; }
.status { font-size: 1em; }
}
</style>
</head>
<body>

<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢ï¼ˆGoogle Place IDï¼‰</h2>
<div id="results"></div>

<script>
const locations = [
{ name: "èƒç£è¥¿ç«™", place_id: "ChIJ0Y8Dyuj4AzQRObQ6ZpLAtpw" },
{ name: "æ—ºè§’æœ—è±ªåŠ", place_id: "ChIJSUsQeMcABDQRUladiJq44qw" },
{ name: "æ·±æ°´åŸ—åœ°éµç«™", place_id: "ChIJUaCTn7QABDQRhlcmZ-02QnU" },
{ name: "å°–æ²™å’€æµ·æ¸¯åŸ", place_id: "ChIJzXN62owABDQRMhRYGJnmKsY" },
{ name: "ä¸­ç’°äº¤æ˜“å»£å ´", place_id: "ChIJmYFgcWMABDQRZKPmTs0JiTQ" }
];

const API_KEY = "MWE3NWNmMzFjZWNiNGMxMDlhNGNhNDFjNTY3ZjZkMTB8NzY5ZGY0MGQ0Zg";

function normalizePopularTimes(arr) {
if (!Array.isArray(arr)) return null;
const map = {};
arr.forEach(dayObj => {
const name = dayObj.day_text;
map[name] = {};
(dayObj.popular_times || []).forEach(item => {
map[name][item.hour] = item.percentage;
});
});
return map;
}

function speak(text, lang) {
const u = new SpeechSynthesisUtterance(text);
u.lang = lang;
window.speechSynthesis.speak(u);
}

function getStatusText(pct) {
if (pct <= 40) return { text: "ç–è½", class: "green" };
if (pct <= 70) return { text: "æ­£å¸¸", class: "yellow" };
return { text: "æ“æ“ ", class: "red" };
}

async function fetchPopularTimes(placeId, retries = 3) {
try {
const res = await fetch(`https://api.app.outscraper.com/maps/details?place_id=${placeId}`, {
headers: { "X-API-KEY": API_KEY }
});
const json = await res.json();
const raw = json.data?.[0]?.popular_times;
return normalizePopularTimes(raw);
} catch (err) {
if (retries > 0) {
console.warn(`âš ï¸ é‡è©¦ä¸­ï¼š${placeId}`);
await new Promise(r => setTimeout(r, 1000));
return await fetchPopularTimes(placeId, retries - 1);
} else {
console.warn(`âŒ æŸ¥è©¢å¤±æ•—ï¼š${placeId}`, err);
return null;
}
}
}

async function displayAll() {
const now = new Date();
const weekday = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
const hour = now.getHours();
const resultDiv = document.getElementById("results");
resultDiv.innerHTML = "";

for (const { name, place_id } of locations) {
const el = document.createElement("div");
el.className = "location";
el.innerHTML = `<h3>${name}</h3><div class="status">â³ è¼‰å…¥ä¸­...</div>`;
resultDiv.appendChild(el);

const data = await fetchPopularTimes(place_id);
const statusEl = el.querySelector(".status");

if (data && data[weekday]?.[hour] !== undefined) {
const percentage = data[weekday][hour];
const { text, class: colorClass } = getStatusText(percentage);
statusEl.className = `status ${colorClass}`;
statusEl.innerText = `ç¾æ™‚äººæµï¼š${text}`;

const lang = navigator.language.startsWith("zh") ? "zh-HK" : "en-US";
const spoken = lang === "zh-HK"
? `${name} ç¾æ™‚äººæµä¿‚ ${text}`
: `Current crowd level at ${name} is ${text}`;
speak(spoken, lang);

console.log(`${name} â†’ âœ… ${text} (${percentage}%)`);
} else {
statusEl.className = "status";
statusEl.innerText = "âš ï¸ æ­¤åœ°é»æš«ç„¡äººæµè³‡æ–™";
console.warn(`${name} â†’ âš ï¸ ç„¡è³‡æ–™`);
}
}
}

displayAll();
setInterval(displayAll, 5 * 60 * 1000);
</script>

</body>
</html>