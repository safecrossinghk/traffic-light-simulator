<!-- crowd10b2-ai.htmlï¼šä½¿ç”¨ AI æ¨¡æ“¬é æ¸¬ -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ“ å³æ™‚äººæµæŸ¥è©¢ + AI é æ¸¬</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body {
font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
padding: 1em;
background: #f8f9fa;
}
h2 { text-align: center; }
input, button {
width: 100%; font-size: 1em;
margin-bottom: 1em; padding: 0.8em;
border-radius: 5px;
}
button { background: #007bff; color: white; border: none; }
#result { background: white; padding: 1em; border-radius: 6px; }
.busy { color: red; font-weight: bold; }
.normal { color: green; font-weight: bold; }
#map { width: 100%; height: 60vh; margin-top: 1em; border-radius: 10px; }
</style>
</head>
<body>
<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢ + AI é æ¸¬</h2>
<input id="keyword" type="text" placeholder="è¼¸å…¥åœ°é»ï¼Œä¾‹å¦‚ï¼šæ—ºè§’æœ—è±ªåŠ" />
<button onclick="query()">æŸ¥è©¢</button>
<div id="result">ğŸ” ç­‰å¾…è¼¸å…¥æŸ¥è©¢...</div>
<div id="map"></div>

<script>
let map;

document.getElementById("keyword").addEventListener("keydown", function (e) {
if (e.key === "Enter") query();
});

async function fetchWithRetry(query, retries = 3, delay = 800) {
for (let i = 0; i < retries; i++) {
try {
const res = await fetch("https://tiny-disk-0d7b.ctakwah.workers.dev/?query=" + encodeURIComponent(query));
const data = await res.json();
if (!data.success) throw new Error(data.message || "æŸ¥è©¢éŒ¯èª¤");
return data;
} catch (e) {
if (i === retries - 1) throw e;
await new Promise(r => setTimeout(r, delay));
}
}
}

function getLabel(percentage) {
if (percentage >= 80) return "ğŸ”´ éå¸¸ç¹å¿™";
if (percentage >= 30) return "ğŸŸ¡ æ­£å¸¸";
return "ğŸŸ¢ åå°‘";
}

function aiPredict(current) {
const preds = [];
let val = current;
for (let i = 1; i <= 3; i++) {
if (val <= 30) val += 10;
else if (val > 70) val -= 10;
else val += Math.random() > 0.5 ? 5 : -5;
val = Math.min(Math.max(Math.round(val), 0), 100);
preds.push(val);
}
return preds;
}

async function query() {
const keyword = document.getElementById("keyword").value.trim();
const resultDiv = document.getElementById("result");
if (!keyword) {
resultDiv.innerHTML = "âš ï¸ è«‹è¼¸å…¥åœ°é»é—œéµå­—ã€‚";
return;
}
resultDiv.innerHTML = "â³ æ­£åœ¨æŸ¥è©¢ä¸­...";

try {
const data = await fetchWithRetry(keyword);
const now = new Date();
const hour = now.getHours();
const today = now.toLocaleDateString("en-US", { weekday: "long" });

// å³æ™‚äººæµç™¾åˆ†æ¯”
let percentage = null;
const live = data.popular_times.find(d => d.day === "live");
if (live?.percentage !== undefined) {
percentage = live.percentage;
} else {
const fallback = data.popular_times.find(d => d.day_text === today);
if (fallback) {
const hourData = fallback.popular_times.find(h => h.hour === hour);
if (hourData) percentage = hourData.percentage;
}
}

if (percentage === null) {
resultDiv.innerHTML = "âš ï¸ ç„¡æ³•å–å¾—äººæµè³‡æ–™ã€‚";
return;
}

const label = getLabel(percentage);
resultDiv.innerHTML = `ğŸ“Œ åœ°é»ï¼š${keyword}<br>ğŸ‘¥ ç¾æ™‚äººæµï¼š<span class="${percentage > 70 ? 'busy' : 'normal'}">${label}ï¼ˆç´„ ${percentage}%ï¼‰</span>`;

const msg = new SpeechSynthesisUtterance(`${keyword} ç¾æ™‚äººæµï¼š${label}`);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);

// AI æ¨¡æ“¬é æ¸¬
const predictions = aiPredict(percentage);
let forecastText = "<br><br>ğŸ“ˆ <b>AI é æ¸¬æœªä¾† 3 å°æ™‚äººæµï¼š</b><ul>";
let speakText = "é æ¸¬ï¼š";
for (let i = 0; i < predictions.length; i++) {
const h = hour + i + 1;
forecastText += `<li>${h}:00 â†’ ${predictions[i]}%</li>`;
speakText += `${h}é» ${predictions[i]}%ã€`;
}
forecastText += "</ul>";
resultDiv.innerHTML += forecastText;

const forecastMsg = new SpeechSynthesisUtterance(speakText);
forecastMsg.lang = "zh-HK";
speechSynthesis.speak(forecastMsg);

// åœ°åœ–è™•ç†
let lat = data.location?.lat;
let lng = data.location?.lng;
if (!lat || !lng) {
const geo = await fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(keyword));
const geoJson = await geo.json();
if (geoJson.length > 0) {
lat = parseFloat(geoJson[0].lat);
lng = parseFloat(geoJson[0].lon);
}
}

if (lat && lng) {
if (map) map.remove();
map = L.map("map").setView([lat, lng], 17);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19
}).addTo(map);
L.marker([lat, lng]).addTo(map).bindPopup(keyword).openPopup();
} else {
resultDiv.innerHTML += "<br>âš ï¸ æ‰¾ä¸åˆ°åœ°åœ–ä½ç½®ã€‚";
}

} catch (err) {
console.error(err);
resultDiv.innerHTML = "âŒ æŸ¥è©¢éŒ¯èª¤ï¼š" + err.message;
}
}
</script>
</body>
</html>