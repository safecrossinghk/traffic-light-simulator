<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>å¯¦æ™‚å·´å£«è¿½è¹¤ï¼šä¹å·´ 2B / åŸå·´ 701A</title>
<style>
#map { height: 80vh; width: 100%; }
#info { padding: 10px; font-size: 16px; }
select { font-size: 16px; padding: 5px; }
</style>
</head>
<body>
<h3>ğŸšŒ å¯¦æ™‚è¿½è¹¤ï¼šä¹å·´ 2B / åŸå·´ 701Aï¼ˆé›™å‘ï¼‰</h3>
<div>
<select id="routeSelect">
<option value="KMB_2B_1">KMB 2B å»å‘1</option>
<option value="KMB_2B_2">KMB 2B å»å‘2</option>
<option value="CTB_701A_1">Citybus 701A å»å‘1</option>
<option value="CTB_701A_2">Citybus 701A å»å‘2</option>
</select>
<button onclick="loadBusData()">è¼‰å…¥è³‡æ–™</button>
</div>
<div id="map"></div>
<div id="info">è³‡æ–™è¼‰å…¥ä¸­...</div>

<script>
let map;
let markers = [];

function initMap() {
map = new google.maps.Map(document.getElementById('map'), {
zoom: 13,
center: { lat: 22.318, lng: 114.169 } // é è¨­ä¹é¾
});
}

async function loadBusData() {
const selectValue = document.getElementById('routeSelect').value;
let apiUrl = "";
if (selectValue.startsWith("KMB")) {
const route = "2B";
const bound = selectValue.endsWith("_1") ? "O" : "I";
apiUrl = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${route}/${bound}`;
} else {
const route = "701A";
const bound = selectValue.endsWith("_1") ? "O" : "I";
apiUrl = `https://rt.data.gov.hk/v1/transport/citybus/eta/CTB/${route}/${bound}`;
}

document.getElementById('info').innerHTML = "è³‡æ–™è¼‰å…¥ä¸­...";
clearMarkers();

try {
const response = await fetch(apiUrl);
const data = await response.json();

if (!data || !data.data || data.data.length === 0) {
document.getElementById('info').innerHTML = "æš«ç„¡ç­æ¬¡";
return;
}

let infoHtml = "";
data.data.forEach(bus => {
if (bus.eta) {
const etaTime = new Date(bus.eta);
const diffMin = Math.round((etaTime - new Date()) / 60000);
infoHtml += `${bus.route}ï¼š${diffMin} åˆ†é˜å¾Œåˆ°é” (${bus.dest_tc})<br>`;
}
});
document.getElementById('info').innerHTML = infoHtml || "æš«ç„¡ç­æ¬¡";

// æ¸¬è©¦åº§æ¨™é¡¯ç¤ºï¼ˆå‡è¨­æ¯å€‹ API æä¾› lat/lonï¼Œå¦å‰‡éœ€é¡å¤–æŸ¥è©¢ï¼‰
data.data.forEach(bus => {
if (bus.lat && bus.long) {
const lat = Number(bus.lat);
const lng = Number(bus.long);
if (!isNaN(lat) && !isNaN(lng)) {
const marker = new google.maps.Marker({
position: { lat: lat, lng: lng },
map: map,
title: bus.route
});
markers.push(marker);
}
}
});

} catch (err) {
console.error(err);
document.getElementById('info').innerHTML = "è³‡æ–™ç²å–å¤±æ•—";
}
}

function clearMarkers() {
markers.forEach(marker => marker.setMap(null));
markers = [];
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCe2towtdCB_tiGtfXFQbdk9Kq63T3D2UU&callback=initMap"></script>
</body>
</html>