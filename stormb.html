<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<title>ğŸŒªï¸ AIé¢¨æš´æ¶ˆæ¯</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: "Helvetica", sans-serif; background: #f0f8ff; margin: 20px; }
h1 { color: #0066cc; }
.box { background: white; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 5px #ccc; }
.warn { background: #ffefc6; padding: 10px; border-left: 5px solid orange; margin-bottom: 10px; }
#map { height: 400px; }
</style>
</head>
<body>
<h1>ğŸŒªï¸ AIé¢¨æš´æ¶ˆæ¯</h1>

<div class="box">
<p>ç‰ˆæœ¬ï¼š<span id="latestTime">è¼‰å…¥ä¸­...</span></p>
<div class="warn" id="hkoWarning">âš ï¸ è¼‰å…¥å¤©æ–‡å°è­¦å‘Šä¸­...</div>
</div>

<div class="box">
<h2>ğŸ—ºï¸ AI é æ¸¬è·¯å¾‘åœ–</h2>
<div id="map"></div>
<p style="font-size: 12px; color: gray;">æœ¬åœ–é¡¯ç¤ºç”± <strong>Aurora æ¨¡æ“¬æ¨¡å‹</strong> é æ¸¬çš„é¢¨æš´ç§»å‹•è·¯å¾‘ã€‚</p>
</div>

<div class="box">
<h2>ğŸŒ¬ï¸ é¢¨çƒæ‡¸æ›æ©Ÿç‡</h2>
<ul id="windProbList"></ul>
</div>

<div class="box">
<h2>ğŸ“† ä¸‰æ—¥å…§å½±éŸ¿é æ¸¬</h2>
<ul id="impactInfo"></ul>
</div>

<div class="box">
<h2>ğŸ§­ æ´»å‹•å»ºè­°åŠ©æ‰‹</h2>
<input id="activityInput" placeholder="è¼¸å…¥æ´»å‹•ï¼ˆå¦‚ï¼š18è™Ÿè¡Œå±±ï¼‰" />
<button onclick="suggestActivity()">å»ºè­°</button>
<p id="activityResult"></p>
</div>

<div class="box">
<h2>ğŸ”Š èªéŸ³é å ±</h2>
<button onclick="speak('zh')">ğŸ“¢ å»£æ±è©±</button>
<button onclick="speak('en')">ğŸ“¢ English</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// æ›¿æ›æˆä½ çš„ Worker URLğŸ‘‡
fetch("https://stormb-api.ctakwah.workers.dev/")
.then(res => res.json())
.then(aiData => {
document.getElementById("latestTime").textContent = aiData.updateTime || "æœªçŸ¥";

// åœ°åœ–
const map = L.map('map').setView([22.3, 114.2], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

if (aiData.path?.length) {
const latlngs = aiData.path.map(p => [p.lat, p.lng]);
L.polyline(latlngs, { color: 'red' }).addTo(map);
L.marker(latlngs[latlngs.length - 1]).addTo(map).bindPopup("æœ€æ–°ä½ç½®").openPopup();
}

// é¢¨çƒæ©Ÿç‡
const wind = ["ä¸€è™Ÿ", "ä¸‰è™Ÿ", "å…«è™Ÿ"];
aiData.hkWindBallProb.forEach((val, i) => {
const li = document.createElement("li");
li.textContent = `${wind[i]}é¢¨çƒæ©Ÿç‡ï¼š${val}%`;
document.getElementById("windProbList").appendChild(li);
});

// å½±éŸ¿é æ¸¬
document.getElementById("impactInfo").innerHTML = `
<li>æœ€æ¥è¿‘é¦™æ¸¯æ™‚é–“ï¼š${aiData.impact.closestTime}</li>
<li>å¯èƒ½æ‡¸æ›å…«è™Ÿä¿¡è™Ÿæ™‚é–“ï¼š${aiData.impact.strongSignalDay}</li>
<li>å»ºè­°ï¼š${aiData.impact.suggestion}</li>
`;

// èªéŸ³é å ±åŠŸèƒ½
window.speak = function (lang) {
const msg = new SpeechSynthesisUtterance();
msg.lang = lang === 'zh' ? 'zh-HK' : 'en-US';
msg.text = aiData.voiceText?.[lang] || "æœªæœ‰é æ¸¬è³‡æ–™ã€‚";
speechSynthesis.speak(msg);
};

// æ´»å‹•å»ºè­°
window.suggestActivity = function () {
const input = document.getElementById("activityInput").value;
const risky = /è¡Œå±±|éœ²ç‡Ÿ|ä¹˜èˆ¹|æˆ¶å¤–|æµ·ç˜|æ´»å‹•/;
const matchDay = input.match(/\d+/);
const date = matchDay ? `ä¸ƒæœˆ${matchDay[0]}æ—¥` : "è©²æ—¥";
const isRisky = risky.test(input);
document.getElementById("activityResult").textContent =
isRisky
? `âš ï¸ AIé æ¸¬${date}é¢¨å‹¢è¼ƒå¤§ï¼Œå»ºè­°å»¶æœŸã€‚`
: `âœ… AIé æ¸¬${date}é¢¨å‹¢ç©©å®šï¼Œæ´»å‹•å¯å¦‚å¸¸é€²è¡Œã€‚`;
};
});

// å¤©æ–‡å°å¯¦æ™‚è­¦å‘Š
fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc")
.then(res => res.json())
.then(data => {
const txt = data?.details || "ç¾æ™‚æ²’æœ‰å¤©æ°£è­¦å‘Šã€‚";
document.getElementById("hkoWarning").textContent = `âš ï¸ ç¾æ™‚è­¦å‘Šï¼š${txt}`;
});
</script>
</body>
</html>
