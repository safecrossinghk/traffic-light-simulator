<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
<style>
body {
font-family: "Segoe UI", sans-serif;
padding: 1em;
background: #f9f9f9;
}
h2 {
margin-top: 0.2em;
}
input, button {
font-size: 1em;
padding: 0.5em;
margin: 0.3em 0;
width: 100%;
box-sizing: border-box;
}
#result {
margin-top: 1em;
padding: 1em;
background: #fff;
border-radius: 8px;
box-shadow: 0 0 4px rgba(0,0,0,0.1);
}
#map {
height: 300px;
margin-top: 1em;
border-radius: 8px;
overflow: hidden;
}
a.waze-link {
display: inline-block;
margin-top: 0.5em;
color: #0057e7;
font-weight: bold;
}
</style>
</head>
<body>
<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</h2>

<!-- âœ… åªä¿ç•™è¼¸å…¥æ¡†èˆ‡æŸ¥è©¢æŒ‰éˆ• -->
<input type="text" id="queryInput" placeholder="è«‹è¼¸å…¥åœ°é»åç¨±" size="30">
<button onclick="fetchCrowd()">æŸ¥è©¢</button>

<div id="result">ğŸ” ç­‰å¾…è¼¸å…¥æŸ¥è©¢...</div>

<script>
document.getElementById("queryInput").addEventListener("keypress", function(e) {
if (e.key === "Enter") fetchCrowd();
});

async function fetchWithRetry(query, retries = 3, delay = 800) {
for (let attempt = 1; attempt <= retries; attempt++) {
try {
console.log(`ğŸ” ç¬¬ ${attempt} æ¬¡æŸ¥è©¢ä¸­...`);
const res = await fetch("https://damp-cloud-8596.ctakwah.workers.dev/?query=" + encodeURIComponent(query));
if (!res.ok) throw new Error("HTTP error " + res.status);
const data = await res.json();
if (!data.success) throw new Error(data.message || "æœªçŸ¥éŒ¯èª¤");
return data;
} catch (e) {
if (attempt === retries) throw e;
await new Promise(resolve => setTimeout(resolve, delay));
}
}
}

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([22.3964, 114.1095], 11); // é è¨­é¦™æ¸¯
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap'
}).addTo(map);
let marker;

async function search() {
const place = document.getElementById("place").value.trim();
const resultDiv = document.getElementById("result");
if (!place) {
resultDiv.innerHTML = "â—è«‹è¼¸å…¥åœ°é»åç¨±ã€‚";
return;
}

resultDiv.innerHTML = "â³ æ­£åœ¨æŸ¥è©¢ä¸­â€¦";

try {
const response = await fetch("https://api.app.outscraper.com/places/search-v2", {
method: "POST",
headers: {
"Content-Type": "application/json",
"X-API-KEY": "MWE3NWNmMzFjZWNiNGMxMDlhNGNhNDFjNTY3ZjZkMTB8NzY5ZGY0MGQ0Zg"
},
body: JSON.stringify({ query: place, limit: 1, language: "zh-TW", region: "HK" })
});

const data = await response.json();
const placeData = data[0]?.places[0];

if (!placeData) {
resultDiv.innerHTML = "âš ï¸ æ‰¾ä¸åˆ°è©²åœ°é»ã€‚";
return;
}

// é¡¯ç¤ºåç¨±èˆ‡åœ°å€
const name = placeData.title || "æœªçŸ¥åœ°é»";
const address = placeData.address || "";
const lat = placeData.coordinates?.lat;
const lng = placeData.coordinates?.lng;

// é¡¯ç¤ºå³æ™‚äººæµè³‡æ–™
let liveItem = null;
if (Array.isArray(placeData.popular_times)) {
// ğŸ” å…ˆæŸ¥å³æ™‚è³‡æ–™ day: "live"
liveItem = placeData.popular_times.find(d => d.day === "live");
}

let label = "â“ ç„¡å³æ™‚äººæµæ•¸æ“š";
if (liveItem && typeof liveItem.percentage === "number") {
if (liveItem.percentage >= 70) label = "ğŸ”´ æ“ é€¼";
else if (liveItem.percentage >= 20) label = "ğŸŸ¡ æ­£å¸¸";
else label = "ğŸŸ¢ åå°‘";
label += `ï¼ˆ${liveItem.percentage}%ï¼‰`;
}

resultDiv.innerHTML = `
ğŸ“Œ <b>${name}</b><br>
ğŸ§­ ${address}<br>
ğŸ‘¥ å³æ™‚äººæµç‹€æ³ï¼š${label}
${lat && lng ? `<br><a class="waze-link" href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank">ğŸš— ä½¿ç”¨ Waze å°èˆª</a>` : ""}
`;

// æ›´æ–°åœ°åœ–
if (lat && lng) {
map.setView([lat, lng], 16);
if (marker) marker.remove();
marker = L.marker([lat, lng]).addTo(map).bindPopup(name).openPopup();
}

} catch (error) {
console.error(error);
resultDiv.innerHTML = "âŒ æŸ¥è©¢æ™‚å‡ºéŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
}
}
</script>
</body>
</html>