<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }
body {
margin: 0;
font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
padding: 1em;
background-color: #f8f9fa;
}
h2 {
font-size: 1.5em;
margin-bottom: 0.8em;
text-align: center;
color: #333;
}
label {
font-size: 1em;
display: block;
margin-bottom: 0.3em;
}
input[type="text"] {
width: 100%;
padding: 0.8em;
font-size: 1.1em;
margin-bottom: 0.8em;
border: 1px solid #ccc;
border-radius: 5px;
}
button {
width: 100%;
padding: 1em;
font-size: 1.1em;
background-color: #007bff;
color: white;
border: none;
border-radius: 5px;
margin-bottom: 1em;
}
#result, #forecast {
font-size: 1.1em;
background-color: #fff;
padding: 1em;
border-radius: 5px;
margin-bottom: 1em;
box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
}
#map {
width: 100%;
height: 60vh;
border-radius: 10px;
overflow: hidden;
}
.busy { color: red; font-weight: bold; }
.normal { color: green; font-weight: bold; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<h2>ğŸ“ å³æ™‚äººæµæŸ¥è©¢</h2>
<label>æŸ¥è©¢åœ°é»é—œéµå­—ï¼š</label>
<input id="keyword" type="text" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯åœ‹éš›æ©Ÿå ´" />
<button onclick="query()">æŸ¥è©¢</button>

<div id="result">ğŸ” ç­‰å¾…è¼¸å…¥æŸ¥è©¢...</div>
<div id="forecast"></div>
<div id="map"></div>

<script>
let map;

document.getElementById("keyword").addEventListener("keydown", function (event) {
if (event.key === "Enter") {
event.preventDefault();
query();
}
});

async function fetchWithRetry(query, retries = 3, delay = 800) {
for (let attempt = 1; attempt <= retries; attempt++) {
try {
const res = await fetch("https://tiny-disk-0d7b.ctakwah.workers.dev/?query=" + encodeURIComponent(query));
if (!res.ok) throw new Error("HTTP error " + res.status);
const data = await res.json();
if (!data.success) throw new Error(data.message || "æœªçŸ¥éŒ¯èª¤");
return data;
} catch (e) {
if (attempt === retries) throw e;
await new Promise(resolve => setTimeout(resolve, delay));
}
}
}

async function query() {
const q = document.getElementById("keyword").value.trim();
const resultDiv = document.getElementById("result");
const forecastDiv = document.getElementById("forecast");
forecastDiv.innerHTML = "";
resultDiv.textContent = "â³ æ­£åœ¨æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...";
document.getElementById("map").innerHTML = "";

if (!q) {
resultDiv.textContent = "â— è«‹è¼¸å…¥æŸ¥è©¢åœ°é»ã€‚";
return;
}

try {
const data = await fetchWithRetry(q, 3);
console.log("âœ… API å›å‚³ï¼š", data);

let percentage = null;
if (Array.isArray(data.popular_times)) {
const liveItem = data.popular_times.find(d => d.day === "live");
if (liveItem && typeof liveItem.percentage === "number") {
percentage = liveItem.percentage;
} else {
const now = new Date();
const todayName = now.toLocaleDateString("en-US", { weekday: "long" });
const currentHour = now.getHours();
const todayData = data.popular_times.find(d => d.day_text === todayName);
if (todayData && Array.isArray(todayData.popular_times)) {
const fallback = todayData.popular_times
.filter(h => h.hour <= currentHour)
.sort((a, b) => b.hour - a.hour)[0];
if (fallback) percentage = fallback.percentage;
}
}
}

if (percentage === null) {
resultDiv.textContent = "âš ï¸ ç„¡æ³•å–å¾—å³æ™‚æˆ–æ­·å²äººæµè³‡æ–™ã€‚";
return;
}

let label = "ğŸŸ¢ åå°‘";
if (percentage >= 80) label = "ğŸ”´ éå¸¸ç¹å¿™";
else if (percentage >= 20) label = "ğŸŸ¡ æ­£å¸¸";

resultDiv.innerHTML = `ğŸ“Œ æŸ¥è©¢åœ°é»ï¼š${q}<br>ğŸ‘¥ ç¾æ™‚äººæµï¼š<span class="${percentage >= 70 ? 'busy' : 'normal'}">${label}ï¼ˆç´„ ${percentage}%ï¼‰</span>`;

const msg = new SpeechSynthesisUtterance(`${q} ç¾æ™‚äººæµï¼š${label}`);
msg.lang = "zh-HK";
speechSynthesis.speak(msg);

// é¡¯ç¤ºåœ°åœ–
let lat = data.location?.lat;
let lng = data.location?.lng;

if ((lat === undefined || lng === undefined) && data.popular_times.length > 0) {
lat = data.popular_times[0].coordinates?.lat;
lng = data.popular_times[0].coordinates?.lng;
}

if (!lat || !lng) {
const geoRes = await fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(q));
const geoData = await geoRes.json();
if (geoData.length > 0) {
lat = parseFloat(geoData[0].lat);
lng = parseFloat(geoData[0].lon);
console.log("âœ… Nominatim è£œä¸Šç¶“ç·¯åº¦ï¼š", lat, lng);
} else {
resultDiv.innerHTML += `<br>âš ï¸ ç„¡æ³•å–å¾—ç¶“ç·¯åº¦è³‡æ–™ï¼Œåœ°åœ–ç„¡æ³•é¡¯ç¤ºã€‚`;
return;
}
}

if (map) map.remove();
map = L.map("map").setView([lat, lng], 17);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
L.marker([lat, lng]).addTo(map).bindPopup(q).openPopup();

// ğŸ”® é æ¸¬æœªä¾†ä¸‰å°æ™‚äººæµ
if (!data.popular_times || data.popular_times.length === 0) {
forecastDiv.innerHTML = "âš ï¸ ç„¡æ³•å–å¾—äººæµé æ¸¬æ•¸æ“š";
} else {
const now = new Date();
const hourNow = now.getHours();
const weekdayIndex = now.getDay();
const weekNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const weekText = weekNames[weekdayIndex];
const todayData = data.popular_times.find(x => x.day === weekText || x.day_text === weekText);

if (!todayData || !todayData.popular_times) {
forecastDiv.innerHTML = "âš ï¸ ä»Šæ—¥é æ¸¬è³‡æ–™ä¸å®Œæ•´";
} else {
let forecastHTML = `<strong>ğŸ“ˆ æœªä¾†ä¸‰å°æ™‚äººæµé æ¸¬ï¼š</strong><br>`;
const futurePercents = [];

for (let i = 1; i <= 3; i++) {
const hour = (hourNow + i) % 24;
const hourData = todayData.popular_times.find(h => h.hour === hour);
const val = hourData ? hourData.percentage : "N/A";
futurePercents.push(val);
forecastHTML += `${hour}:00 âœ ${val}%<br>`;
}

forecastDiv.innerHTML = forecastHTML;

const forecastMsg = new SpeechSynthesisUtterance(`${q} æœªä¾†ä¸‰å°æ™‚é æ¸¬äººæµç‚ºï¼š${futurePercents.join("%ã€")}%ã€‚`);
forecastMsg.lang = "zh-HK";
speechSynthesis.speak(forecastMsg);
}
}

} catch (e) {
console.error("âŒ æŸ¥è©¢å¤±æ•—ï¼š", e);
resultDiv.textContent = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + e.message;
}
}
</script>

</body>
</html>