<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>è‡ªå‹•è¼ªæŸ¥äº”åœ°é»äººæµ Crowd8c</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; padding: 20px; background: #f9f9f9; text-align: center; }
.location-box { margin: 30px auto; padding: 20px; width: 90%; max-width: 400px; background: #fff;
border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.place { font-size: 1.5em; margin-bottom: 10px; }
.status { font-size: 2em; font-weight: bold; }
.green { color: green; }
.yellow { color: orange; }
.red { color: red; }
</style>
</head>
<body>
<h2>ğŸ“ äº”åœ°é»è‡ªå‹•å³æ™‚äººæµæª¢è¦–</h2>
<div class="location-box">
<div id="placeName" class="place">â”€â”€â”€</div>
<div id="placeStatus" class="status">â”€â”€â”€</div>
</div>

<script>
const locations = [
"èƒç£è¥¿ç«™",
"æ—ºè§’æœ—è±ªåŠ",
"æ·±æ°´åŸ—åœ°éµç«™",
"å°–æ²™å’€æµ·æ¸¯åŸ",
"ä¸­ç’°äº¤æ˜“å»£å ´"
];
let index = 0;

async function fetchCrowd(place) {
try {
const res = await fetch("https://damp-cloud-8596.ctakwah.workers.dev/?query=" + encodeURIComponent(place));
const data = await res.json();

console.log(`[${place}] API â†’`, data);
let percentage, title;

if (data.current_popularity && typeof data.current_popularity.percentage === "number") {
percentage = data.current_popularity.percentage;
title = data.current_popularity.title || '';
console.log(`[${place}] å³æ™‚è³‡æ–™ä½¿ç”¨ï¼Œ%=${percentage}, title=${title}`);
} else if (Array.isArray(data.popular_times)) {
const now = new Date(), today = now.toLocaleDateString("en-US",{weekday:"long"}), h = now.getHours();
const todayData = data.popular_times.find(d=>d.day_text===today);
if (todayData && Array.isArray(todayData.popular_times)) {
const f = todayData.popular_times
.filter(it=>it.hour <= h)
.sort((a,b)=>b.hour - a.hour)[0];
if (f) {
percentage = f.percentage;
title = f.title || '';
console.log(`[${place}] ä½¿ç”¨æ­·å² fallback %=${percentage}, title=${title}`);
}
}
}

if (typeof percentage !== 'number') {
return { status: 'âš ï¸ æš«ç„¡è³‡æ–™', color: '' };
}

let label = '', cls = '';
if (percentage >= 70) { label = 'æ“ è¿«'; cls = 'red'; }
else if (percentage >= 40) { label = 'æ­£å¸¸'; cls = 'yellow'; }
else { label = 'ç–è½'; cls = 'green'; }

return { status: `${label}`, color: cls };
} catch (err) {
console.error(`[${place}] æŸ¥è©¢éŒ¯èª¤`, err);
return { status: 'âš ï¸ æŸ¥è©¢å¤±æ•—', color: '' };
}
}

async function rotate() {
const place = locations[index];
document.getElementById('placeName').textContent = place;
document.getElementById('placeStatus').textContent = 'â³ æŸ¥è©¢ä¸­...';
document.getElementById('placeStatus').className = 'status';

const result = await fetchCrowd(place);
document.getElementById('placeStatus').textContent = result.status;
document.getElementById('placeStatus').className = 'status ' + result.color;

index = (index + 1) % locations.length;
}

rotate();
setInterval(rotate, 8000);
</script>
</body>
</html>