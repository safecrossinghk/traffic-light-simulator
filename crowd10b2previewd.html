<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ“ å³æ™‚äººæµé æ¸¬ï¼ˆç¤ºç¯„ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: sans-serif; padding: 1em; }
input, button { font-size: 1em; padding: 0.5em; }
.busy { color: red; font-weight: bold; }
.normal { color: green; }
</style>
</head>
<body>
<h2>ğŸ“ å³æ™‚äººæµé æ¸¬ï¼ˆç¤ºç¯„ï¼‰</h2>
<input type="text" id="queryInput" placeholder="è¼¸å…¥åœ°é»åç¨±ï¼ˆå¦‚ Times Squareï¼‰">
<button onclick="query()">æŸ¥è©¢</button>
<div id="result" style="margin-top: 1em;"></div>

<script>
let latestData = null; // å„²å­˜æœ€è¿‘ä¸€æ¬¡çš„ API å›å‚³è³‡æ–™

async function query() {
const q = document.getElementById('queryInput').value.trim();
if (!q) return alert("è«‹è¼¸å…¥åœ°é»åç¨±");
document.getElementById('result').innerHTML = 'â³ æŸ¥è©¢ä¸­...';

try {
const res = await fetch(`https://crowd-status-query.aiworker.workers.dev/?q=${encodeURIComponent(q)}`);
const data = await res.json();
latestData = data;

if (!data || !data.populartimes || !data.populartimes.length) {
throw new Error("æ‰¾ä¸åˆ°äººæµè³‡æ–™");
}

const now = new Date();
const currentDay = now.getDay();
const currentHour = now.getHours();

const todayData = data.populartimes.find(p => p.name.toLowerCase() === getWeekdayName(currentDay).toLowerCase());
if (!todayData) throw new Error("æ‰¾ä¸åˆ°ä»Šå¤©çš„äººæµè³‡æ–™");

const percentage = todayData.data[currentHour];
const label = percentage >= 70 ? 'ç¹å¿™' : (percentage >= 40 ? 'ä¸­ç­‰' : 'æš¢é †');

const resultDiv = document.getElementById('result');
resultDiv.innerHTML = `
ğŸ“Œ æŸ¥è©¢åœ°é»ï¼š${q}<br>
ğŸ‘¥ ç¾æ™‚äººæµï¼š<span class="${percentage >= 70 ? 'busy' : 'normal'}">${label}ï¼ˆç´„ ${percentage}%ï¼‰</span><br><br>
<button onclick="showForecast('${q}')">ğŸ“ˆ æŸ¥çœ‹æœªä¾† 3 å°æ™‚é æ¸¬</button>
`;
} catch (e) {
console.error(e);
document.getElementById('result').innerHTML = 'âš ï¸ ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
}
}

function getWeekdayName(dayIndex) {
const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
return days[dayIndex];
}

function showForecast(place) {
try {
const data = latestData;
if (!data || !data.populartimes) throw new Error("æ²’æœ‰å¯ç”¨çš„é æ¸¬è³‡æ–™");

const now = new Date();
const currentDay = now.getDay();
const currentHour = now.getHours();

const todayData = data.populartimes.find(p => p.name.toLowerCase() === getWeekdayName(currentDay).toLowerCase());
if (!todayData) throw new Error("ç„¡æ³•æ‰¾åˆ°ä»Šæ—¥äººæµé æ¸¬");

let forecastHTML = `<strong>ğŸ“ˆ ${place} æœªä¾† 3 å°æ™‚äººæµé æ¸¬ï¼š</strong><br>`;
for (let i = 1; i <= 3; i++) {
const hour = (currentHour + i) % 24;
const percentage = todayData.data[hour];
const label = percentage >= 70 ? 'ç¹å¿™' : (percentage >= 40 ? 'ä¸­ç­‰' : 'æš¢é †');
forecastHTML += `ğŸ•’ ${hour}:00 - <span class="${percentage >= 70 ? 'busy' : 'normal'}">${label}ï¼ˆç´„ ${percentage}%ï¼‰</span><br>`;
}

document.getElementById('result').innerHTML += `<br>${forecastHTML}`;
} catch (e) {
alert("âš ï¸ ç„¡æ³•é¡¯ç¤ºé æ¸¬è³‡æ–™");
console.error(e);
}
}
</script>
</body>
</html>