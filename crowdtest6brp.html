<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸŒ§ï¸ é¦™æ¸¯é›¨é‡è‡¨è¿‘é æ¸¬</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
font-family: "Helvetica Neue", sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
text-align: center;
}
h1 {
font-size: 1.4em;
margin: 1em 0 0.5em;
}
#map {
height: 300px;
margin: 0 10px;
border-radius: 8px;
border: 1px solid #ccc;
}
#rain-alert {
margin: 1em;
font-size: 1.2em;
font-weight: bold;
}
#debug {
font-size: 0.9em;
color: #666;
margin: 10px;
white-space: pre-line;
}
</style>
</head>
<body>
<h1>ğŸŒ‚ é¦™æ¸¯é›¨é‡è‡¨è¿‘é æ¸¬</h1>
<div id="map"></div>
<div id="rain-alert">â³ æ­£åœ¨è®€å–é æ¸¬è³‡æ–™...</div>
<div id="debug">ğŸ“¡ æº–å‚™ä¸­...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest6br.ctakwah.workers.dev/'; // âœ… æ”¹æˆä½ è‡ªå·± Cloudflare Worker çš„ç¶²å€

const debug = (msg) => {
const el = document.getElementById("debug");
el.innerText = `[DEBUG] ${msg}`;
};

const map = L.map('map').setView([22.3, 114.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker;

function setMarker(lat, lon) {
if (marker) map.removeLayer(marker);
marker = L.marker([lat, lon]).addTo(map);
}

function fetchForecast(lat, lon) {
debug(`ğŸŒ ç™¼é€è‡³ Worker...\nlat: ${lat}, lon: ${lon}`);
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => {
if (!res.ok) throw new Error(`HTTP error ${res.status}`);
return res.json();
})
.then(data => {
console.log("API å›å‚³è³‡æ–™ï¼š", data);
const alertDiv = document.getElementById('rain-alert');

if (data && typeof data.immediateRain === "number") {
const rain = data.immediateRain.toFixed(1);
if (data.rainExpected) {
alertDiv.innerText = `âš ï¸ å³æ™‚é›¨é‡ ${rain}mmï¼Œè«‹æº–å‚™é›¨å…·`;
speak("âš ï¸ ä½ é™„è¿‘æœ‰é™é›¨");
} else {
alertDiv.innerText = `â˜€ï¸ å³æ™‚é›¨é‡ ${rain}mmï¼Œæš«æ™‚ç„¡éœ€æ“”å¿ƒ`;
}

debug(`âœ… æˆåŠŸå–å¾—å›æ‡‰\nå³æ™‚é›¨é‡: ${rain}mm\né›¨é‡é æœŸ: ${data.rainExpected}`);
} else {
alertDiv.innerText = "âš ï¸ ç„¡æ³•è®€å–é æ¸¬è³‡æ–™";
debug("âš ï¸ Worker å›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤");
}
})
.catch(err => {
console.error("è®€å–é æ¸¬éŒ¯èª¤", err);
document.getElementById('rain-alert').innerText = "âš ï¸ ç„¡æ³•å–å¾—é æ¸¬è³‡æ–™";
debug(`âŒ Worker ç„¡æ³•é€£ç·šæˆ–å‡ºéŒ¯\néŒ¯èª¤è¨Šæ¯ï¼š${err.message}`);
});
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

function initLocation() {
if (!navigator.geolocation) {
const fallbackLat = 22.3;
const fallbackLon = 114.2;
map.setView([fallbackLat, fallbackLon], 11);
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
debug("âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œå·²ä½¿ç”¨é è¨­åº§æ¨™");
return;
}

navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
console.log("âœ… å–å¾—å®šä½ï¼š", lat, lon);
map.setView([lat, lon], 13);
setMarker(lat, lon);
fetchForecast(lat, lon);
debug(`ğŸ“ æˆåŠŸå®šä½\nlat: ${lat}\nlon: ${lon}`);
},
err => {
console.warn("âš ï¸ å®šä½å¤±æ•—ï¼š", err);
const fallbackLat = 22.3;
const fallbackLon = 114.2;
map.setView([fallbackLat, fallbackLon], 11);
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
debug(`âŒ å®šä½å¤±æ•—ï¼Œå·²ç”¨é è¨­ä½ç½®\néŒ¯èª¤ç¢¼ï¼š${err.code}\nåŸå› ï¼š${err.message}`);
},
{ enableHighAccuracy: true, timeout: 8000 }
);
}

initLocation();
</script>
</body>
</html>